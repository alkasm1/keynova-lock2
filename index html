<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" >
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keynova Lock - Ù‚ÙÙ„ Ø¨ØµØ±ÙŠ Ø¢Ù…Ù†</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&family=Noto+Kufi+Arabic:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* ============ CSS Variables ============ */
:root {
  --primary: #e8740c;
  --primary-light: #ff9d3d;
  --primary-glow: rgba(232, 116, 12, 0.35);
  --accent: #f0a500;
  --dark-bg: #0a0e17;
  --dark-card: #111827;
  --dark-card2: #1a2235;
  --dark-border: rgba(255,255,255,0.06);
  --dark-text: #e4e8f1;
  --dark-muted: #7a8599;
  --success: #22c55e;
  --success-bg: rgba(34,197,94,0.12);
  --danger: #ef4444;
  --danger-bg: rgba(239,68,68,0.12);
  --warning: #f59e0b;
  --warning-bg: rgba(245,158,11,0.12);
  --info: #3b82f6;
  --info-bg: rgba(59,130,246,0.12);
  --radius: 14px;
  --radius-sm: 10px;
  --shadow: 0 8px 32px rgba(0,0,0,0.35);
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --font-main: 'Almarai', 'Noto Kufi Arabic', sans-serif;
}

html.light {
  --dark-bg: #f0f2f7;
  --dark-card: #ffffff;
  --dark-card2: #f8f9fc;
  --dark-border: rgba(0,0,0,0.08);
  --dark-text: #1a202c;
  --dark-muted: #64748b;
  --shadow: 0 8px 32px rgba(0,0,0,0.08);
}

/* ============ Reset & Base ============ */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: var(--font-main);
  background: var(--dark-bg);
  color: var(--dark-text);
  min-height: 100vh;
  direction: rtl;
  text-align: right;
  overflow-x: hidden;
  line-height: 1.6;
}

/* Animated background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 600px 400px at 20% 10%, rgba(232,116,12,0.08), transparent),
    radial-gradient(ellipse 500px 500px at 80% 85%, rgba(59,130,246,0.06), transparent),
    radial-gradient(ellipse 400px 300px at 50% 50%, rgba(240,165,0,0.04), transparent);
  pointer-events: none;
  z-index: 0;
}

html.light body::before {
  background:
    radial-gradient(ellipse 600px 400px at 20% 10%, rgba(232,116,12,0.05), transparent),
    radial-gradient(ellipse 500px 500px at 80% 85%, rgba(59,130,246,0.04), transparent);
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }

/* ============ Layout ============ */
.app-container {
  position: relative;
  z-index: 1;
  max-width: 520px;
  margin: 0 auto;
  padding: 16px;
  min-height: 100vh;
}

/* ============ Header ============ */
.app-header {
  text-align: center;
  padding: 24px 0 20px;
  animation: fadeSlideDown 0.6s ease-out;
}

@keyframes fadeSlideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.logo-wrap {
  position: relative;
  width: 88px;
  height: 88px;
  margin: 0 auto 16px;
}

.logo-ring {
  position: absolute;
  inset: -6px;
  border-radius: 50%;
  border: 2px solid var(--primary);
  opacity: 0.3;
  animation: pulseRing 2.5s ease-in-out infinite;
}

@keyframes pulseRing {
  0%, 100% { transform: scale(1); opacity: 0.3; }
  50% { transform: scale(1.12); opacity: 0.1; }
}

.logo-icon {
  width: 88px;
  height: 88px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary), #d45d00);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 24px var(--primary-glow);
  position: relative;
}

.logo-icon i {
  font-size: 36px;
  color: #fff;
}

.app-header h1 {
  font-family: 'Noto Kufi Arabic', sans-serif;
  font-size: 30px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary-light), var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 4px;
}

.app-header .tagline {
  color: var(--dark-muted);
  font-size: 14px;
  font-weight: 400;
}

.app-header .dev-credit {
  color: var(--dark-muted);
  font-size: 12px;
  margin-top: 4px;
  opacity: 0.7;
}

/* ============ Navigation Tabs ============ */
.nav-tabs {
  display: flex;
  gap: 4px;
  background: var(--dark-card);
  border: 1px solid var(--dark-border);
  border-radius: var(--radius);
  padding: 4px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  animation: fadeSlideDown 0.6s ease-out 0.1s both;
}

.nav-tab {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 12px 8px;
  background: transparent;
  color: var(--dark-muted);
  border: none;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-family: var(--font-main);
  font-size: 14px;
  font-weight: 600;
  transition: var(--transition);
  position: relative;
  white-space: nowrap;
}

.nav-tab i { font-size: 15px; }

.nav-tab:hover { color: var(--dark-text); background: rgba(232,116,12,0.06); }

.nav-tab.active {
  background: linear-gradient(135deg, var(--primary), #d45d00);
  color: #fff;
  box-shadow: 0 4px 16px var(--primary-glow);
}

.nav-tab .badge {
  position: absolute;
  top: 4px;
  left: 4px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--danger);
  display: none;
}

/* ============ Tab Panes ============ */
.tab-pane {
  display: none;
  animation: fadeIn 0.4s ease-out;
}

.tab-pane.active { display: block; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ============ Cards ============ */
.card {
  background: var(--dark-card);
  border: 1px solid var(--dark-border);
  border-radius: var(--radius);
  padding: 22px;
  margin-bottom: 16px;
  box-shadow: var(--shadow);
  transition: var(--transition);
}

.card:hover {
  border-color: rgba(232,116,12,0.15);
}

.card-title {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 18px;
  font-size: 17px;
  font-weight: 700;
  color: var(--dark-text);
}

.card-title .icon-circle {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.icon-orange { background: rgba(232,116,12,0.12); color: var(--primary); }
.icon-green { background: var(--success-bg); color: var(--success); }
.icon-blue { background: var(--info-bg); color: var(--info); }
.icon-red { background: var(--danger-bg); color: var(--danger); }

/* ============ Form Elements ============ */
.form-label {
  display: block;
  font-size: 13px;
  font-weight: 700;
  color: var(--primary-light);
  margin-bottom: 8px;
  letter-spacing: 0.3px;
}

.input-wrap {
  position: relative;
  margin-bottom: 16px;
}

.input-wrap input {
  width: 100%;
  padding: 14px 16px;
  padding-left: 44px;
  background: var(--dark-card2);
  border: 1px solid var(--dark-border);
  border-radius: var(--radius-sm);
  color: var(--dark-text);
  font-family: var(--font-main);
  font-size: 16px;
  transition: var(--transition);
  outline: none;
}

.input-wrap input:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-glow);
}

.input-wrap input::placeholder { color: var(--dark-muted); opacity: 0.6; }

.input-toggle {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--dark-muted);
  cursor: pointer;
  font-size: 18px;
  padding: 4px;
  transition: var(--transition);
}

.input-toggle:hover { color: var(--primary); }

/* ============ Password Strength ============ */
.strength-bar {
  height: 4px;
  border-radius: 2px;
  background: var(--dark-card2);
  margin-top: 8px;
  overflow: hidden;
}

.strength-fill {
  height: 100%;
  border-radius: 2px;
  width: 0;
  transition: width 0.4s ease, background 0.4s ease;
}

.strength-text {
  font-size: 11px;
  margin-top: 4px;
  color: var(--dark-muted);
  transition: color 0.3s;
}

/* ============ Image Gallery ============ */
.gallery-label {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 8px;
}

.gallery-label span {
  font-size: 12px;
  color: var(--dark-muted);
}

.image-gallery {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  max-height: 320px;
  overflow-y: auto;
  padding: 8px;
  background: var(--dark-card2);
  border-radius: var(--radius-sm);
  border: 1px solid var(--dark-border);
}

.img-cell {
  position: relative;
  aspect-ratio: 1;
  border-radius: 8px;
  overflow: hidden;
  cursor: pointer;
  border: 2px solid transparent;
  transition: var(--transition);
  background: var(--dark-card);
}

.img-cell:hover {
  border-color: rgba(232,116,12,0.4);
  transform: scale(1.04);
}

.img-cell.picked {
  border-color: var(--primary);
  box-shadow: 0 0 12px var(--primary-glow);
}

.img-cell.picked::after {
  content: '\f00c';
  font-family: 'Font Awesome 6 Free';
  font-weight: 900;
  position: absolute;
  top: 4px;
  right: 4px;
  width: 20px;
  height: 20px;
  background: var(--primary);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  z-index: 2;
}

.img-cell img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.img-cell .img-num {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,0.75));
  color: #fff;
  font-size: 10px;
  text-align: center;
  padding: 12px 4px 4px;
  opacity: 0;
  transition: opacity 0.3s;
}

.img-cell:hover .img-num { opacity: 1; }

/* ============ Buttons ============ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 14px 20px;
  border: none;
  border-radius: var(--radius-sm);
  font-family: var(--font-main);
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}

.btn::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(rgba(255,255,255,0.15), transparent);
  opacity: 0;
  transition: opacity 0.3s;
}

.btn:hover::after { opacity: 1; }
.btn:active { transform: scale(0.98); }

.btn-primary {
  background: linear-gradient(135deg, var(--primary), #d45d00);
  color: #fff;
  box-shadow: 0 4px 16px var(--primary-glow);
}

.btn-primary:hover { box-shadow: 0 6px 24px var(--primary-glow); transform: translateY(-1px); }

.btn-ghost {
  background: var(--dark-card2);
  color: var(--dark-text);
  border: 1px solid var(--dark-border);
}

.btn-ghost:hover { border-color: var(--primary); color: var(--primary); }

.btn-danger {
  background: linear-gradient(135deg, var(--danger), #c62828);
  color: #fff;
}

.btn-success {
  background: linear-gradient(135deg, var(--success), #16a34a);
  color: #fff;
}

.btn-info {
  background: linear-gradient(135deg, var(--info), #2563eb);
  color: #fff;
}

.btn-sm {
  padding: 10px 16px;
  font-size: 14px;
}

.btn-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 12px;
}

/* ============ Alerts / Toasts ============ */
.toast-container {
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  pointer-events: none;
  width: 90%;
  max-width: 440px;
}

.toast {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 14px 18px;
  border-radius: var(--radius-sm);
  font-size: 14px;
  font-weight: 600;
  font-family: var(--font-main);
  direction: rtl;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  pointer-events: auto;
  animation: toastIn 0.4s ease-out;
  border: 1px solid;
}

.toast.leaving { animation: toastOut 0.3s ease-in forwards; }

@keyframes toastIn {
  from { opacity: 0; transform: translateY(-16px) scale(0.96); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes toastOut {
  to { opacity: 0; transform: translateY(-16px) scale(0.96); }
}

.toast-success { background: #0d2818; border-color: rgba(34,197,94,0.3); color: #4ade80; }
.toast-error { background: #2a0f0f; border-color: rgba(239,68,68,0.3); color: #fca5a5; }
.toast-warning { background: #2a1f05; border-color: rgba(245,158,11,0.3); color: #fbbf24; }
.toast-info { background: #0c1929; border-color: rgba(59,130,246,0.3); color: #93c5fd; }

html.light .toast-success { background: #f0fdf4; color: #166534; }
html.light .toast-error { background: #fef2f2; color: #991b1b; }
html.light .toast-warning { background: #fffbeb; color: #92400e; }
html.light .toast-info { background: #eff6ff; color: #1e40af; }

.toast i { font-size: 18px; flex-shrink: 0; }

/* ============ Session Bar ============ */
.session-bar {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: var(--dark-card);
  border: 1px solid rgba(34,197,94,0.2);
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  animation: fadeIn 0.4s ease-out;
}

.session-bar.visible { display: flex; }

.session-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--success);
  animation: blink 1.5s ease-in-out infinite;
  flex-shrink: 0;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.session-bar .session-text {
  flex: 1;
  font-size: 13px;
  color: var(--dark-muted);
}

.session-bar .session-time {
  font-weight: 700;
  color: var(--success);
  font-size: 14px;
  font-variant-numeric: tabular-nums;
}

.session-bar .lock-btn {
  background: none;
  border: 1px solid var(--dark-border);
  color: var(--dark-muted);
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  transition: var(--transition);
  font-family: var(--font-main);
}

.session-bar .lock-btn:hover {
  border-color: var(--danger);
  color: var(--danger);
}

/* ============ Protected Items ============ */
.protected-list {
  list-style: none;
  margin-top: 12px;
}

.protected-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: var(--dark-card2);
  border: 1px solid var(--dark-border);
  border-radius: 8px;
  margin-bottom: 6px;
  font-size: 14px;
  animation: fadeIn 0.3s ease-out;
}

.protected-item .p-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}

.protected-item .p-info { flex: 1; }
.protected-item .p-name { font-weight: 600; font-size: 13px; }
.protected-item .p-type { font-size: 11px; color: var(--dark-muted); }

.protected-item .p-remove {
  background: none;
  border: none;
  color: var(--dark-muted);
  cursor: pointer;
  font-size: 14px;
  padding: 4px;
  transition: var(--transition);
}

.protected-item .p-remove:hover { color: var(--danger); }

/* Custom input for protected items */
.add-item-row {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.add-item-row input, .add-item-row select {
  flex: 1;
  padding: 10px 12px;
  background: var(--dark-card2);
  border: 1px solid var(--dark-border);
  border-radius: 8px;
  color: var(--dark-text);
  font-family: var(--font-main);
  font-size: 14px;
  outline: none;
  transition: var(--transition);
}

.add-item-row input:focus, .add-item-row select:focus {
  border-color: var(--primary);
}

.add-item-row select {
  flex: 0.6;
  cursor: pointer;
}

.add-item-row select option {
  background: var(--dark-card);
}

.add-btn {
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 14px;
  cursor: pointer;
  font-size: 16px;
  transition: var(--transition);
  flex-shrink: 0;
}

.add-btn:hover { background: #d45d00; }

/* ============ Activity Log ============ */
.log-list {
  list-style: none;
  max-height: 240px;
  overflow-y: auto;
}

.log-entry {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--dark-border);
  font-size: 13px;
  animation: fadeIn 0.3s ease-out;
}

.log-entry:last-child { border-bottom: none; }

.log-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-top: 6px;
  flex-shrink: 0;
}

.log-entry .log-msg { flex: 1; color: var(--dark-text); }
.log-entry .log-time { color: var(--dark-muted); font-size: 11px; white-space: nowrap; }

/* ============ Attempts Counter ============ */
.attempts-notice {
  display: none;
  align-items: center;
  gap: 8px;
  padding: 10px 14px;
  background: var(--danger-bg);
  border: 1px solid rgba(239,68,68,0.2);
  border-radius: 8px;
  font-size: 13px;
  color: var(--danger);
  margin-top: 12px;
}

.attempts-notice.visible { display: flex; }

.attempts-notice i { font-size: 16px; }

/* ============ Lockout Overlay ============ */
.lockout-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 8000;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 20px;
}

.lockout-overlay.visible { display: flex; }

.lockout-content {
  background: var(--dark-card);
  border: 1px solid rgba(239,68,68,0.3);
  border-radius: var(--radius);
  padding: 40px 30px;
  max-width: 380px;
  width: 100%;
}

.lockout-content i {
  font-size: 56px;
  color: var(--danger);
  margin-bottom: 16px;
  animation: shake 0.6s ease;
}

@keyframes shake {
  0%, 100% { transform: rotate(0); }
  20% { transform: rotate(-8deg); }
  40% { transform: rotate(8deg); }
  60% { transform: rotate(-4deg); }
  80% { transform: rotate(4deg); }
}

.lockout-content h2 {
  color: var(--danger);
  font-size: 22px;
  margin-bottom: 8px;
}

.lockout-content p {
  color: var(--dark-muted);
  font-size: 14px;
  margin-bottom: 20px;
}

.lockout-timer {
  font-size: 36px;
  font-weight: 800;
  color: var(--dark-text);
  font-variant-numeric: tabular-nums;
}

/* ============ Confirm Modal ============ */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.65);
  z-index: 9000;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal-overlay.visible { display: flex; }

.modal-box {
  background: var(--dark-card);
  border: 1px solid var(--dark-border);
  border-radius: var(--radius);
  padding: 30px 24px;
  max-width: 380px;
  width: 100%;
  text-align: center;
  box-shadow: 0 16px 48px rgba(0,0,0,0.4);
  animation: modalIn 0.3s ease-out;
}

@keyframes modalIn {
  from { opacity: 0; transform: scale(0.9) translateY(10px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-box .modal-icon {
  font-size: 44px;
  color: var(--warning);
  margin-bottom: 16px;
}

.modal-box .modal-msg {
  font-size: 15px;
  color: var(--dark-text);
  line-height: 1.6;
  margin-bottom: 24px;
}

.modal-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.modal-actions .btn { width: auto; min-width: 100px; }

/* ============ Instructions ============ */
.info-box {
  background: var(--dark-card2);
  border-radius: var(--radius-sm);
  padding: 16px;
  margin-top: 16px;
  border-right: 3px solid var(--primary);
}

.info-box h4 {
  font-size: 14px;
  color: var(--primary);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.info-box ul {
  padding-right: 16px;
  margin: 0;
}

.info-box li {
  font-size: 13px;
  color: var(--dark-muted);
  margin-bottom: 6px;
  line-height: 1.5;
}

/* ============ Export Key Area ============ */
.export-area {
  margin-top: 16px;
}

.key-display {
  display: none;
  padding: 10px 14px;
  background: var(--dark-card2);
  border: 1px solid var(--dark-border);
  border-radius: 8px;
  font-size: 12px;
  word-break: break-all;
  color: var(--dark-muted);
  margin-top: 8px;
  font-family: 'Courier New', monospace;
  direction: ltr;
  text-align: left;
  position: relative;
}

.key-display.visible { display: block; }

.copy-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 4px 10px;
  font-size: 11px;
  cursor: pointer;
  font-family: var(--font-main);
  transition: var(--transition);
}

.copy-btn:hover { background: #d45d00; }

/* ============ Import Area ============ */
.import-row {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.import-row input {
  flex: 1;
  padding: 10px 12px;
  background: var(--dark-card2);
  border: 1px solid var(--dark-border);
  border-radius: 8px;
  color: var(--dark-text);
  font-family: monospace;
  font-size: 13px;
  outline: none;
  direction: ltr;
  transition: var(--transition);
}

.import-row input:focus { border-color: var(--primary); }

/* ============ Empty state ============ */
.empty-state {
  text-align: center;
  padding: 32px 16px;
  color: var(--dark-muted);
}

.empty-state i {
  font-size: 40px;
  margin-bottom: 12px;
  opacity: 0.4;
}

.empty-state p {
  font-size: 14px;
  line-height: 1.5;
}

/* ============ Stats Row ============ */
.stats-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-bottom: 16px;
}

.stat-card {
  background: var(--dark-card);
  border: 1px solid var(--dark-border);
  border-radius: var(--radius-sm);
  padding: 14px 10px;
  text-align: center;
}

.stat-card .stat-num {
  font-size: 22px;
  font-weight: 800;
  color: var(--primary);
}

.stat-card .stat-label {
  font-size: 11px;
  color: var(--dark-muted);
  margin-top: 2px;
}

/* ============ Responsive ============ */
@media (max-width: 480px) {
  .app-container { padding: 10px; }
  .card { padding: 18px; }
  .image-gallery { grid-template-columns: repeat(3, 1fr); }
  .btn-row { grid-template-columns: 1fr; }
  .nav-tab { font-size: 12px; padding: 10px 6px; }
  .nav-tab i { font-size: 13px; }
  .stats-row { grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
  .stat-card { padding: 10px 6px; }
  .stat-card .stat-num { font-size: 18px; }
  .modal-actions { flex-direction: column; }
  .modal-actions .btn { width: 100%; }
}
</style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Lockout Overlay -->
<div class="lockout-overlay" id="lockoutOverlay">
  <div class="lockout-content">
    <i class="fas fa-ban"></i>
    <h2>ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</h2>
    <p>ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
    <div class="lockout-timer" id="lockoutTimer">02:00</div>
  </div>
</div>

<!-- Confirm Modal -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal-box">
    <div class="modal-icon"><i class="fas fa-exclamation-triangle"></i></div>
    <p class="modal-msg" id="confirmMsg"></p>
    <div class="modal-actions">
      <button class="btn btn-ghost btn-sm" id="confirmCancel">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="btn btn-primary btn-sm" id="confirmOk">ØªØ£ÙƒÙŠØ¯</button>
    </div>
  </div>
</div>

<div class="app-container">

  <!-- Header -->
  <header class="app-header">
    <div class="logo-wrap">
      <div class="logo-ring"></div>
      <div class="logo-icon"><i class="fas fa-fingerprint"></i></div>
    </div>
    <h1>Keynova Lock</h1>
    <p class="tagline">Ù‚ÙÙ„ Ø¨ØµØ±ÙŠ Ø¢Ù…Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ± ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
    <p class="dev-credit">Ù…Ø·ÙˆØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…: Ø±Ø£ÙØª Ø¹Ù…Ø±</p>
  </header>

  <!-- Session Bar -->
  <div class="session-bar" id="sessionBar">
    <div class="session-indicator"></div>
    <span class="session-text">Ø§Ù„Ø¬Ù„Ø³Ø© Ù†Ø´Ø·Ø©</span>
    <span class="session-time" id="sessionTime">10:00</span>
    <button class="lock-btn" id="lockBtn"><i class="fas fa-lock"></i> Ù‚ÙÙ„</button>
  </div>

  <!-- Navigation -->
  <nav class="nav-tabs" id="navTabs">
    <button class="nav-tab active" data-tab="unlock">
      <i class="fas fa-unlock-alt"></i> ÙØªØ­ Ø§Ù„Ù‚ÙÙ„
    </button>
    <button class="nav-tab" data-tab="settings">
      <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      <span class="badge" id="settingsBadge"></span>
    </button>
    <button class="nav-tab" data-tab="log">
      <i class="fas fa-clipboard-list"></i> Ø§Ù„Ø³Ø¬Ù„
    </button>
  </nav>

  <!-- ========== TAB: UNLOCK ========== -->
  <div class="tab-pane active" id="pane-unlock">
    <div class="card">
      <div class="card-title">
        <span class="icon-circle icon-orange"><i class="fas fa-key"></i></span>
        ÙØªØ­ Ø§Ù„Ù‚ÙÙ„
      </div>

      <div class="gallery-label">
        <label class="form-label" style="margin-bottom:0">Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±Ø©</label>
        <span id="verifySelected">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</span>
      </div>
      <div class="image-gallery" id="verifyGallery"></div>

      <div style="margin-top:16px">
        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <div class="input-wrap">
          <input type="password" id="verifyPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off">
          <button class="input-toggle" data-target="verifyPassword" aria-label="Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><i class="fas fa-eye"></i></button>
        </div>
      </div>

      <button class="btn btn-primary" id="verifyBtn">
        <i class="fas fa-shield-alt"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­
      </button>

      <div class="attempts-notice" id="attemptsNotice">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="attemptsText"></span>
      </div>
    </div>

    <div class="info-box">
      <h4><i class="fas fa-lightbulb"></i> ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h4>
      <ul>
        <li>Ø§Ø®ØªØ± Ù†ÙØ³ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙƒÙ…ÙØªØ§Ø­ Ø£Ø³Ø§Ø³ÙŠ</li>
        <li>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„ØµÙˆØ±Ø©</li>
        <li>Ø¨Ø¹Ø¯ 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ§Ø´Ù„Ø© Ø³ÙŠØªÙ… Ø­Ø¸Ø±Ùƒ Ù„Ù…Ø¯Ø© Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†</li>
        <li>Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ†ØªÙ‡ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„Ù†Ø´Ø§Ø·</li>
      </ul>
    </div>
  </div>

  <!-- ========== TAB: SETTINGS ========== -->
  <div class="tab-pane" id="pane-settings">

    <!-- No Key State -->
    <div class="card" id="noKeyCard" style="display:none">
      <div class="empty-state">
        <i class="fas fa-key"></i>
        <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ù…Ø­ÙÙˆØ¸<br>Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ Ø§ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹</p>
      </div>
    </div>

    <!-- Set Key Card -->
    <div class="card" id="setKeyCard">
      <div class="card-title">
        <span class="icon-circle icon-orange"><i class="fas fa-key"></i></span>
        <span id="keyCardTitle">ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯</span>
      </div>

      <div class="gallery-label">
        <label class="form-label" style="margin-bottom:0">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ù…ÙØªØ§Ø­</label>
        <span id="settingsSelected">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±</span>
      </div>
      <div class="image-gallery" id="settingsGallery"></div>

      <div style="margin-top:16px">
        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <div class="input-wrap">
          <input type="password" id="setPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ© (4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" autocomplete="off">
          <button class="input-toggle" data-target="setPassword" aria-label="Ø¥Ø¸Ù‡Ø§Ø± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><i class="fas fa-eye"></i></button>
        </div>
        <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
        <div class="strength-text" id="strengthText"></div>
      </div>

      <button class="btn btn-primary" id="setKeyBtn" style="margin-top:8px">
        <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­
      </button>

      <div class="btn-row" style="margin-top:10px">
        <button class="btn btn-danger btn-sm" id="removeKeyBtn">
          <i class="fas fa-trash-alt"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­
        </button>
        <button class="btn btn-ghost btn-sm" id="exportKeyBtn">
          <i class="fas fa-download"></i> ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­
        </button>
      </div>

      <div class="export-area">
        <div class="key-display" id="keyDisplay">
          <button class="copy-btn" id="copyKeyBtn"><i class="fas fa-copy"></i> Ù†Ø³Ø®</button>
          <span id="keyText"></span>
        </div>
      </div>

      <div class="import-row" style="margin-top:12px">
        <input type="text" id="importInput" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙØµØ¯Ù‘Ø± Ù‡Ù†Ø§...">
        <button class="btn btn-info btn-sm" id="importKeyBtn" style="width:auto;min-width:80px">
          <i class="fas fa-upload"></i> Ø§Ø³ØªÙŠØ±Ø§Ø¯
        </button>
      </div>
    </div>

    <!-- Protection Card -->
    <div class="card" id="protectionCard">
      <div class="card-title">
        <span class="icon-circle icon-green"><i class="fas fa-shield-alt"></i></span>
        Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø­Ù…ÙŠØ©
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-num" id="statFiles">0</div>
          <div class="stat-label">Ù…Ù„ÙØ§Øª</div>
        </div>
        <div class="stat-card">
          <div class="stat-num" id="statApps">0</div>
          <div class="stat-label">ØªØ·Ø¨ÙŠÙ‚Ø§Øª</div>
        </div>
        <div class="stat-card">
          <div class="stat-num" id="statSites">0</div>
          <div class="stat-label">Ù…ÙˆØ§Ù‚Ø¹</div>
        </div>
      </div>

      <ul class="protected-list" id="protectedList"></ul>

      <div class="add-item-row">
        <input type="text" id="newItemName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±...">
        <select id="newItemType">
          <option value="file">ğŸ“ Ù…Ù„Ù</option>
          <option value="app">ğŸ“± ØªØ·Ø¨ÙŠÙ‚</option>
          <option value="site">ğŸŒ Ù…ÙˆÙ‚Ø¹</option>
        </select>
        <button class="add-btn" id="addItemBtn" title="Ø¥Ø¶Ø§ÙØ©"><i class="fas fa-plus"></i></button>
      </div>
    </div>
  </div>

  <!-- ========== TAB: LOG ========== -->
  <div class="tab-pane" id="pane-log">
    <div class="card">
      <div class="card-title">
        <span class="icon-circle icon-blue"><i class="fas fa-clipboard-list"></i></span>
        Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø·
      </div>

      <ul class="log-list" id="logList">
        <li class="empty-state" id="logEmpty">
          <i class="fas fa-inbox"></i>
          <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø· Ù…Ø³Ø¬Ù„ Ø¨Ø¹Ø¯</p>
        </li>
      </ul>

      <button class="btn btn-ghost btn-sm" id="clearLogBtn" style="margin-top:12px">
        <i class="fas fa-eraser"></i> Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„
      </button>
    </div>
  </div>

</div>

<script>
/* =====================================================
   Keynova Lock â€” Enhanced Version
   ===================================================== */

// â”€â”€â”€ State â”€â”€â”€
const state = {
  storedHash: null,
  protectedItems: [],
  activityLog: [],
  selectedVerifyImage: null,
  selectedSettingsImage: null,
  sessionActive: false,
  sessionTimerId: null,
  sessionSecondsLeft: 0,
  failedAttempts: 0,
  maxAttempts: 5,
  lockoutSeconds: 120,
  lockoutTimerId: null,
  lockedUntil: 0,
};

// â”€â”€â”€ Image base path â”€â”€â”€
const IMAGE_BASE = 'https://alkasm1.github.io/keynova-lock2/images/';
const IMAGE_COUNT = 28;

function getImageUrl(index) {
  return IMAGE_BASE + 'image' + index + '.jpg';
}

// â”€â”€â”€ Dark / Light mode â”€â”€â”€
(function initTheme() {
  if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
    document.documentElement.classList.add('light');
  }
  window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', function(e) {
    if (e.matches) {
      document.documentElement.classList.add('light');
    } else {
      document.documentElement.classList.remove('light');
    }
  });
})();

// â”€â”€â”€ Toast Notifications â”€â”€â”€
function showToast(message, type) {
  type = type || 'info';
  var container = document.getElementById('toastContainer');
  var icons = {
    success: 'fas fa-check-circle',
    error: 'fas fa-times-circle',
    warning: 'fas fa-exclamation-triangle',
    info: 'fas fa-info-circle'
  };
  var toast = document.createElement('div');
  toast.className = 'toast toast-' + type;
  toast.innerHTML = '<i class="' + (icons[type] || icons.info) + '"></i><span>' + message + '</span>';
  container.appendChild(toast);
  setTimeout(function() {
    toast.classList.add('leaving');
    setTimeout(function() {
      if (toast.parentNode) toast.parentNode.removeChild(toast);
    }, 300);
  }, 3500);
}

// â”€â”€â”€ Confirm Dialog â”€â”€â”€
function showConfirm(message) {
  return new Promise(function(resolve) {
    var overlay = document.getElementById('confirmModal');
    document.getElementById('confirmMsg').textContent = message;
    overlay.classList.add('visible');

    function cleanup(result) {
      overlay.classList.remove('visible');
      document.getElementById('confirmOk').removeEventListener('click', onOk);
      document.getElementById('confirmCancel').removeEventListener('click', onCancel);
      overlay.removeEventListener('click', onOverlay);
      resolve(result);
    }

    function onOk() { cleanup(true); }
    function onCancel() { cleanup(false); }
    function onOverlay(e) { if (e.target === overlay) cleanup(false); }

    document.getElementById('confirmOk').addEventListener('click', onOk);
    document.getElementById('confirmCancel').addEventListener('click', onCancel);
    overlay.addEventListener('click', onOverlay);
  });
}

// â”€â”€â”€ SHA-256 Hash â”€â”€â”€
async function sha256(text) {
  var encoder = new TextEncoder();
  var data = encoder.encode(text);
  var hashBuffer = await crypto.subtle.digest('SHA-256', data);
  var hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
}

async function computeKey(imageId, password) {
  // Double hash for extra security
  var combined = 'keynova_v2_img:' + imageId + '|pwd:' + password + '|salt:kn0va2025';
  var firstHash = await sha256(combined);
  return await sha256(firstHash + ':' + password.length + ':' + imageId);
}

// â”€â”€â”€ Activity Log â”€â”€â”€
function addLog(message, type) {
  type = type || 'info';
  var entry = {
    message: message,
    type: type,
    time: new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', second: '2-digit' })
  };
  state.activityLog.unshift(entry);
  if (state.activityLog.length > 50) state.activityLog.pop();
  renderLog();
}

function renderLog() {
  var list = document.getElementById('logList');
  var empty = document.getElementById('logEmpty');

  if (state.activityLog.length === 0) {
    list.innerHTML = '';
    list.appendChild(empty);
    empty.style.display = '';
    return;
  }

  empty.style.display = 'none';
  var html = '';
  var colors = { success: 'var(--success)', error: 'var(--danger)', warning: 'var(--warning)', info: 'var(--info)' };

  state.activityLog.forEach(function(entry) {
    html += '<li class="log-entry">' +
      '<span class="log-dot" style="background:' + (colors[entry.type] || colors.info) + '"></span>' +
      '<span class="log-msg">' + entry.message + '</span>' +
      '<span class="log-time">' + entry.time + '</span>' +
      '</li>';
  });
  list.innerHTML = html;
  list.appendChild(empty);
}

// â”€â”€â”€ Image Gallery â”€â”€â”€
function buildGallery(containerId, isSettings) {
  var container = document.getElementById(containerId);
  container.innerHTML = '';

  for (var i = 1; i <= IMAGE_COUNT; i++) {
    (function(idx) {
      var cell = document.createElement('div');
      cell.className = 'img-cell';
      cell.dataset.idx = idx;

      var img = document.createElement('img');
      img.src = getImageUrl(idx);
      img.alt = 'ØµÙˆØ±Ø© ' + idx;
      img.loading = 'lazy';
      img.draggable = false;

      var num = document.createElement('div');
      num.className = 'img-num';
      num.textContent = idx;

      cell.appendChild(img);
      cell.appendChild(num);

      cell.addEventListener('click', function() {
        pickImage(containerId, idx, isSettings);
      });

      container.appendChild(cell);
    })(i);
  }
}

function pickImage(containerId, idx, isSettings) {
  var container = document.getElementById(containerId);
  container.querySelectorAll('.img-cell').forEach(function(c) { c.classList.remove('picked'); });

  var picked = container.querySelector('[data-idx="' + idx + '"]');
  if (picked) picked.classList.add('picked');

  if (isSettings) {
    state.selectedSettingsImage = idx;
    document.getElementById('settingsSelected').textContent = 'Ø§Ù„ØµÙˆØ±Ø© ' + idx;
  } else {
    state.selectedVerifyImage = idx;
    document.getElementById('verifySelected').textContent = 'Ø§Ù„ØµÙˆØ±Ø© ' + idx;
  }
}

// â”€â”€â”€ Password Strength â”€â”€â”€
function evaluateStrength(password) {
  var score = 0;
  if (password.length >= 4) score++;
  if (password.length >= 8) score++;
  if (password.length >= 12) score++;
  if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
  if (/\d/.test(password)) score++;
  if (/[^a-zA-Z0-9]/.test(password)) score++;
  return Math.min(score, 5);
}

function updateStrengthUI(password) {
  var fill = document.getElementById('strengthFill');
  var text = document.getElementById('strengthText');

  if (!password) {
    fill.style.width = '0';
    text.textContent = '';
    return;
  }

  var score = evaluateStrength(password);
  var levels = [
    { width: '20%', color: '#ef4444', label: 'Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹' },
    { width: '40%', color: '#f97316', label: 'Ø¶Ø¹ÙŠÙØ©' },
    { width: '60%', color: '#eab308', label: 'Ù…ØªÙˆØ³Ø·Ø©' },
    { width: '80%', color: '#22c55e', label: 'Ù‚ÙˆÙŠØ©' },
    { width: '100%', color: '#10b981', label: 'Ù‚ÙˆÙŠØ© Ø¬Ø¯Ø§Ù‹' }
  ];

  var level = levels[Math.max(0, score - 1)] || levels[0];
  fill.style.width = level.width;
  fill.style.background = level.color;
  text.textContent = level.label;
  text.style.color = level.color;
}

// â”€â”€â”€ Password Toggle â”€â”€â”€
document.addEventListener('click', function(e) {
  var toggle = e.target.closest('.input-toggle');
  if (!toggle) return;
  var targetId = toggle.dataset.target;
  var input = document.getElementById(targetId);
  if (!input) return;

  if (input.type === 'password') {
    input.type = 'text';
    toggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
  } else {
    input.type = 'password';
    toggle.innerHTML = '<i class="fas fa-eye"></i>';
  }
});

// â”€â”€â”€ Tabs â”€â”€â”€
document.getElementById('navTabs').addEventListener('click', function(e) {
  var tab = e.target.closest('.nav-tab');
  if (!tab) return;

  var tabName = tab.dataset.tab;

  // Settings require session (if hash exists)
  if (tabName === 'settings' && state.storedHash && !state.sessionActive) {
    showToast('ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'warning');
    return;
  }

  document.querySelectorAll('.nav-tab').forEach(function(t) { t.classList.remove('active'); });
  tab.classList.add('active');

  document.querySelectorAll('.tab-pane').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById('pane-' + tabName).classList.add('active');
});

function switchTab(name) {
  document.querySelectorAll('.nav-tab').forEach(function(t) {
    t.classList.toggle('active', t.dataset.tab === name);
  });
  document.querySelectorAll('.tab-pane').forEach(function(p) { p.classList.remove('active'); });
  document.getElementById('pane-' + name).classList.add('active');
}

// â”€â”€â”€ Lockout â”€â”€â”€
function startLockout() {
  state.lockedUntil = Date.now() + state.lockoutSeconds * 1000;
  var overlay = document.getElementById('lockoutOverlay');
  overlay.classList.add('visible');
  addLog('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù„Ù…Ø¯Ø© ' + (state.lockoutSeconds / 60) + ' Ø¯Ù‚ÙŠÙ‚Ø©', 'error');

  function tick() {
    var remaining = Math.max(0, Math.ceil((state.lockedUntil - Date.now()) / 1000));
    var m = Math.floor(remaining / 60);
    var s = remaining % 60;
    document.getElementById('lockoutTimer').textContent =
      String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');

    if (remaining <= 0) {
      clearInterval(state.lockoutTimerId);
      overlay.classList.remove('visible');
      state.failedAttempts = 0;
      updateAttemptsUI();
      addLog('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø­Ø¸Ø±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'info');
    }
  }

  tick();
  state.lockoutTimerId = setInterval(tick, 1000);
}

function updateAttemptsUI() {
  var notice = document.getElementById('attemptsNotice');
  var text = document.getElementById('attemptsText');
  if (state.failedAttempts > 0) {
    notice.classList.add('visible');
    var remaining = state.maxAttempts - state.failedAttempts;
    text.textContent = 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙØ§Ø´Ù„Ø©: ' + state.failedAttempts + ' â€” Ù…ØªØ¨Ù‚ÙŠ ' + remaining + ' Ù…Ø­Ø§ÙˆÙ„Ø§Øª';
  } else {
    notice.classList.remove('visible');
  }
}

// â”€â”€â”€ Verify Key â”€â”€â”€
document.getElementById('verifyBtn').addEventListener('click', async function() {
  // Check lockout
  if (Date.now() < state.lockedUntil) {
    showToast('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'error');
    return;
  }

  if (!state.selectedVerifyImage) {
    showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'warning');
    return;
  }

  var password = document.getElementById('verifyPassword').value;
  if (!password) {
    showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'warning');
    return;
  }

  if (!state.storedHash) {
    showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ù…Ø­ÙÙˆØ¸ØŒ Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'warning');
    switchTab('settings');
    return;
  }

  showToast('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...', 'info');

  try {
    var hash = await computeKey(state.selectedVerifyImage, password);

    if (hash === state.storedHash) {
      state.failedAttempts = 0;
      updateAttemptsUI();
      startSession();
      showToast('ØªÙ… ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ', 'success');
      addLog('ØªÙ… ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    } else {
      state.failedAttempts++;
      updateAttemptsUI();
      addLog('Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ù‚ÙÙ„ ÙØ§Ø´Ù„Ø© (Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ' + state.failedAttempts + ')', 'error');

      if (state.failedAttempts >= state.maxAttempts) {
        startLockout();
        showToast('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª!', 'error');
      } else {
        showToast('Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
      }
    }
  } catch (err) {
    console.error('Verify error:', JSON.stringify(err));
    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚', 'error');
  }
});

// â”€â”€â”€ Session Management â”€â”€â”€
function startSession() {
  state.sessionActive = true;
  state.sessionSecondsLeft = 600; // 10 minutes
  var bar = document.getElementById('sessionBar');
  bar.classList.add('visible');
  updateSessionUI();

  if (state.sessionTimerId) clearInterval(state.sessionTimerId);
  state.sessionTimerId = setInterval(function() {
    state.sessionSecondsLeft--;
    updateSessionUI();
    if (state.sessionSecondsLeft <= 0) {
      endSession();
      showToast('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©', 'warning');
      addLog('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹', 'warning');
    }
  }, 1000);
}

function updateSessionUI() {
  var m = Math.floor(state.sessionSecondsLeft / 60);
  var s = state.sessionSecondsLeft % 60;
  document.getElementById('sessionTime').textContent =
    String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
}

function endSession() {
  state.sessionActive = false;
  if (state.sessionTimerId) {
    clearInterval(state.sessionTimerId);
    state.sessionTimerId = null;
  }
  document.getElementById('sessionBar').classList.remove('visible');

  // Clear verify selections
  state.selectedVerifyImage = null;
  state.selectedSettingsImage = null;
  document.getElementById('verifyPassword').value = '';
  document.getElementById('verifySelected').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±';
  document.getElementById('settingsSelected').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±';
  document.querySelectorAll('.img-cell').forEach(function(c) { c.classList.remove('picked'); });

  switchTab('unlock');
}

document.getElementById('lockBtn').addEventListener('click', function() {
  endSession();
  showToast('ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©', 'info');
  addLog('ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹', 'warning');
});

// â”€â”€â”€ Set Key â”€â”€â”€
document.getElementById('setKeyBtn').addEventListener('click', async function() {
  if (!state.selectedSettingsImage) {
    showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© ÙƒÙ…ÙØªØ§Ø­', 'warning');
    return;
  }

  var password = document.getElementById('setPassword').value;
  if (!password) {
    showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'warning');
    return;
  }

  if (password.length < 4) {
    showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'warning');
    return;
  }

  var msg = state.storedHash
    ? 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ ØªØ£ÙƒØ¯ Ù…Ù† Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯.'
    : 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ØŸ ØªØ£ÙƒØ¯ Ù…Ù† ØªØ°ÙƒØ± Ø§Ù„ØµÙˆØ±Ø© ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';

  var confirmed = await showConfirm(msg);
  if (!confirmed) return;

  try {
    var hash = await computeKey(state.selectedSettingsImage, password);
    state.storedHash = hash;
    showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    addLog('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯', 'success');

    // Clear inputs
    document.getElementById('setPassword').value = '';
    updateStrengthUI('');
    state.selectedSettingsImage = null;
    document.getElementById('settingsSelected').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±';
    document.getElementById('settingsGallery').querySelectorAll('.img-cell').forEach(function(c) {
      c.classList.remove('picked');
    });

    updateSettingsState();
  } catch (err) {
    console.error('Set key error:', JSON.stringify(err));
    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­', 'error');
  }
});

// â”€â”€â”€ Remove Key â”€â”€â”€
document.getElementById('removeKeyBtn').addEventListener('click', async function() {
  if (!state.storedHash) {
    showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ù„Ø¥Ø²Ø§Ù„ØªÙ‡', 'warning');
    return;
  }

  var confirmed = await showConfirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ©.');
  if (!confirmed) return;

  state.storedHash = null;
  state.protectedItems = [];
  renderProtectedItems();
  endSession();
  showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù†Ø¬Ø§Ø­', 'success');
  addLog('ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ©', 'error');
  updateSettingsState();
});

// â”€â”€â”€ Export / Import Key â”€â”€â”€
document.getElementById('exportKeyBtn').addEventListener('click', function() {
  if (!state.storedHash) {
    showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ù„ØªØµØ¯ÙŠØ±Ù‡', 'warning');
    return;
  }

  var display = document.getElementById('keyDisplay');
  var keyText = document.getElementById('keyText');

  var exportData = btoa(JSON.stringify({
    h: state.storedHash,
    v: 2,
    t: Date.now()
  }));

  keyText.textContent = exportData;
  display.classList.add('visible');
  addLog('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­', 'info');
});

document.getElementById('copyKeyBtn').addEventListener('click', function() {
  var text = document.getElementById('keyText').textContent;
  navigator.clipboard.writeText(text).then(function() {
    showToast('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…ÙØªØ§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©', 'success');
  });
});

document.getElementById('importKeyBtn').addEventListener('click', async function() {
  var input = document.getElementById('importInput').value.trim();
  if (!input) {
    showToast('ÙŠØ±Ø¬Ù‰ Ù„ØµÙ‚ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…ÙØµØ¯Ù‘Ø±', 'warning');
    return;
  }

  try {
    var decoded = JSON.parse(atob(input));
    if (!decoded.h || decoded.v !== 2) {
      showToast('Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù† Ø¥ØµØ¯Ø§Ø± ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚', 'error');
      return;
    }

    var confirmed = await showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù…ÙØªØ§Ø­ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø­Ø§Ù„ÙŠ.');
    if (!confirmed) return;

    state.storedHash = decoded.h;
    document.getElementById('importInput').value = '';
    showToast('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
    addLog('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯', 'success');
    updateSettingsState();
  } catch (err) {
    showToast('Ø§Ù„Ù…ÙØªØ§Ø­ ØºÙŠØ± ØµØ§Ù„Ø­', 'error');
  }
});

// â”€â”€â”€ Protected Items â”€â”€â”€
function renderProtectedItems() {
  var list = document.getElementById('protectedList');
  list.innerHTML = '';

  var counts = { file: 0, app: 0, site: 0 };
  var icons = {
    file: { icon: 'fas fa-file-alt', cls: 'icon-blue' },
    app: { icon: 'fas fa-mobile-alt', cls: 'icon-orange' },
    site: { icon: 'fas fa-globe', cls: 'icon-green' }
  };
  var typeNames = { file: 'Ù…Ù„Ù', app: 'ØªØ·Ø¨ÙŠÙ‚', site: 'Ù…ÙˆÙ‚Ø¹' };

  state.protectedItems.forEach(function(item, idx) {
    counts[item.type] = (counts[item.type] || 0) + 1;
    var info = icons[item.type] || icons.file;

    var li = document.createElement('li');
    li.className = 'protected-item';
    li.innerHTML =
      '<div class="p-icon ' + info.cls + '"><i class="' + info.icon + '"></i></div>' +
      '<div class="p-info"><div class="p-name">' + item.name + '</div><div class="p-type">' + (typeNames[item.type] || item.type) + '</div></div>' +
      '<button class="p-remove" data-idx="' + idx + '" title="Ø¥Ø²Ø§Ù„Ø©"><i class="fas fa-times"></i></button>';
    list.appendChild(li);
  });

  document.getElementById('statFiles').textContent = counts.file || 0;
  document.getElementById('statApps').textContent = counts.app || 0;
  document.getElementById('statSites').textContent = counts.site || 0;
}

document.getElementById('protectedList').addEventListener('click', function(e) {
  var btn = e.target.closest('.p-remove');
  if (!btn) return;
  var idx = parseInt(btn.dataset.idx, 10);
  var name = state.protectedItems[idx] ? state.protectedItems[idx].name : '';
  state.protectedItems.splice(idx, 1);
  renderProtectedItems();
  showToast('ØªÙ… Ø¥Ø²Ø§Ù„Ø© "' + name + '" Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©', 'info');
  addLog('ØªÙ… Ø¥Ø²Ø§Ù„Ø© "' + name + '" Ù…Ù† Ø§Ù„Ø­Ù…Ø§ÙŠØ©', 'warning');
});

document.getElementById('addItemBtn').addEventListener('click', function() {
  var nameInput = document.getElementById('newItemName');
  var typeSelect = document.getElementById('newItemType');
  var name = nameInput.value.trim();

  if (!name) {
    showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù†ØµØ±', 'warning');
    return;
  }

  if (!state.sessionActive && state.storedHash) {
    showToast('ÙŠØ±Ø¬Ù‰ ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
    return;
  }

  state.protectedItems.push({ name: name, type: typeSelect.value });
  nameInput.value = '';
  renderProtectedItems();
  showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© "' + name + '" Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ©', 'success');
  addLog('ØªÙ… Ø¥Ø¶Ø§ÙØ© "' + name + '" Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù…Ø§ÙŠØ©', 'success');
});

// â”€â”€â”€ Clear Log â”€â”€â”€
document.getElementById('clearLogBtn').addEventListener('click', async function() {
  if (state.activityLog.length === 0) {
    showToast('Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº Ø¨Ø§Ù„ÙØ¹Ù„', 'info');
    return;
  }
  var confirmed = await showConfirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ');
  if (!confirmed) return;
  state.activityLog = [];
  renderLog();
  showToast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„', 'success');
});

// â”€â”€â”€ Settings State â”€â”€â”€
function updateSettingsState() {
  var noKey = document.getElementById('noKeyCard');
  var setKeyCard = document.getElementById('setKeyCard');
  var keyTitle = document.getElementById('keyCardTitle');

  if (!state.storedHash) {
    noKey.style.display = '';
    keyTitle.textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯';
  } else {
    noKey.style.display = 'none';
    keyTitle.textContent = 'ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­';
  }
}

// â”€â”€â”€ Password strength listener â”€â”€â”€
document.getElementById('setPassword').addEventListener('input', function() {
  updateStrengthUI(this.value);
});

// Allow Enter key to trigger verify
document.getElementById('verifyPassword').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    document.getElementById('verifyBtn').click();
  }
});

document.getElementById('setPassword').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    document.getElementById('setKeyBtn').click();
  }
});

document.getElementById('newItemName').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    document.getElementById('addItemBtn').click();
  }
});

// â”€â”€â”€ Init â”€â”€â”€
(function init() {
  buildGallery('verifyGallery', false);
  buildGallery('settingsGallery', true);
  updateSettingsState();
  renderProtectedItems();
  renderLog();
  addLog('ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'info');
})();
</script>
</body>
</html>
