<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keynova Lock - قفل بصري آمن</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<style>
:root {
--primary: #ff8800;
--primary-dark: #e67600;
--dark: #121212;
--dark-light: #1e1e1e;
--light: #f5f5f5;
--success: #00c853;
--danger: #ff4444;
--warning: #ffbb33;
--gray: #8d8d8d;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Tajawal', Arial, sans-serif;
background-color: var(--dark);
color: var(--light);
min-height: 100vh;
padding: 20px;
direction: rtl;
text-align: right;
}

.container {
max-width: 500px;
margin: 0 auto;
padding: 20px;
}

header {
text-align: center;
padding: 20px 0 30px;
position: relative;
}

.logo {
background: linear-gradient(135deg, #ff8800, #ff5500);
width: 80px;
height: 80px;
border-radius: 50%;
margin: 0 auto 15px;
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 5px 15px rgba(255, 136, 0, 0.3);
}

.logo i {
font-size: 36px;
color: white;
}

h1 {
color: var(--primary);
font-size: 28px;
margin-bottom: 5px;
}

.subtitle {
color: var(--gray);
font-size: 16px;
font-weight: 400;
}

.card {
background-color: var(--dark-light);
border-radius: 16px;
padding: 25px;
margin-bottom: 20px;
box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
transition: all 0.3s ease;
border: 1px solid rgba(255, 255, 255, 0.05);
}

.card-header {
display: flex;
align-items: center;
margin-bottom: 20px;
color: var(--primary);
}

.card-header i {
font-size: 22px;
margin-left: 10px;
}

.card-header h3 {
font-size: 20px;
font-weight: 700;
}

.form-group {
margin-bottom: 20px;
}

.file-input {
width: 100%;
padding: 15px;
background-color: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 10px;
color: var(--light);
font-size: 16px;
cursor: pointer;
transition: all 0.3s ease;
}

.file-input:hover {
border-color: var(--primary);
}

.file-input:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 2px rgba(255, 136, 0, 0.2);
}

.image-gallery {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
gap: 10px;
max-height: 300px;
overflow-y: auto;
padding: 10px;
background: rgba(255, 255, 255, 0.03);
border-radius: 10px;
border: 1px solid rgba(255, 255, 255, 0.1);
}

.image-item {
position: relative;
aspect-ratio: 1;
border-radius: 8px;
overflow: hidden;
cursor: pointer;
transition: all 0.3s ease;
border: 2px solid transparent;
}

.image-item:hover {
transform: scale(1.05);
border-color: var(--primary);
}

.image-item.selected {
border-color: var(--primary);
box-shadow: 0 0 10px rgba(255, 136, 0, 0.5);
}

.image-item img {
width: 100%;
height: 100%;
object-fit: cover;
}

.image-number {
position: absolute;
top: 5px;
right: 5px;
background: rgba(0, 0, 0, 0.7);
color: white;
border-radius: 50%;
width: 20px;
height: 20px;
display: flex;
align-items: center;
justify-content: center;
font-size: 12px;
font-weight: bold;
}

.image-name {
position: absolute;
bottom: 0;
left: 0;
right: 0;
background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
color: white;
padding: 8px 6px 6px;
font-size: 10px;
text-align: center;
opacity: 0;
transition: opacity 0.3s ease;
}

.image-item:hover .image-name {
opacity: 1;
}

.btn {
display: block;
width: 100%;
padding: 15px;
background: var(--primary);
color: white;
border: none;
border-radius: 10px;
font-size: 18px;
font-weight: 700;
cursor: pointer;
transition: all 0.3s ease;
margin-top: 10px;
text-align: center;
}

.btn:hover {
background: var(--primary-dark);
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(255, 136, 0, 0.3);
}

.btn:active {
transform: translateY(0);
}

.btn-secondary {
background: rgba(255, 255, 255, 0.1);
}

.btn-secondary:hover {
background: rgba(255, 255, 255, 0.2);
box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.btn-danger {
background: var(--danger);
}

.btn-danger:hover {
background: #e53935;
box-shadow: 0 5px 15px rgba(255, 68, 68, 0.3);
}

.btn-success {
background: var(--success);
}

.btn-success:hover {
background: #00b248;
box-shadow: 0 5px 15px rgba(0, 200, 83, 0.3);
}

select {
width: 100%;
padding: 15px;
background-color: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 10px;
color: var(--light);
font-size: 16px;
margin-bottom: 15px;
}

select:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 2px rgba(255, 136, 0, 0.2);
}

.result {
padding: 15px;
border-radius: 10px;
margin-top: 20px;
text-align: center;
font-size: 18px;
font-weight: 500;
display: none;
}

.success {
background-color: rgba(0, 200, 83, 0.15);
color: #00ff99;
display: block;
}

.fail {
background-color: rgba(255, 68, 68, 0.15);
color: #ff4444;
display: block;
}

.warning {
background-color: rgba(255, 187, 51, 0.15);
color: #ffbb33;
display: block;
}

.hidden {
display: none;
}

.action-buttons {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
margin-top: 20px;
}

.action-buttons .btn {
margin: 0;
}

.session-timeout {
background: rgba(255, 187, 51, 0.1);
border: 1px solid rgba(255, 187, 51, 0.2);
padding: 10px;
border-radius: 10px;
text-align: center;
margin-top: 20px;
font-size: 14px;
color: var(--warning);
}

.instructions {
background: rgba(255, 255, 255, 0.03);
border-radius: 10px;
padding: 15px;
margin-top: 25px;
border-left: 3px solid var(--primary);
}

.instructions h4 {
color: var(--primary);
margin-bottom: 10px;
}

.instructions ul {
padding-right: 20px;
}

.instructions li {
margin-bottom: 8px;
color: var(--gray);
}

.tab-content {
display: none;
}

.active-tab {
display: block;
}

.tabs {
display: flex;
justify-content: space-between;
background: rgba(255, 255, 255, 0.05);
border-radius: 12px;
padding: 5px;
margin-bottom: 20px;
}

.tab-btn {
flex: 1;
padding: 12px;
text-align: center;
background: transparent;
color: var(--gray);
border: none;
border-radius: 10px;
cursor: pointer;
font-weight: 500;
transition: all 0.3s ease;
}

.tab-btn.active {
background: var(--primary);
color: white;
box-shadow: 0 4px 10px rgba(255, 136, 0, 0.3);
}

.status-icon {
margin-left: 10px;
}

.no-key-message {
text-align: center;
padding: 30px;
color: var(--warning);
}

.access-denied {
text-align: center;
padding: 30px;
color: var(--danger);
font-size: 18px;
}

.access-denied i {
font-size: 48px;
margin-bottom: 15px;
display: block;
}

@media (max-width: 480px) {
.container {
padding: 10px;
}

.card {
padding: 20px;
}

.action-buttons {
grid-template-columns: 1fr;
}

h1 {
font-size: 24px;
}

.card-header h3 {
font-size: 18px;
}

.image-gallery {
grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div class="logo">
<i class="fas fa-lock"></i>
</div>
<h1>Keynova Lock</h1>
<p class="subtitle">قفل بصري آمن باستخدام الصور وكلمة المرور</p>
<p class="subtitle">مطور البرنامج م: رأفت عمر</p>
</header>

<div class="tabs">
<button id="verify-tab" class="tab-btn active" onclick="openTab('verify')">فتح القفل</button>
<button id="settings-tab" class="tab-btn" onclick="openTab('settings')">الإعدادات</button>
</div>

<!-- واجهة التحقق -->
<div id="verify" class="tab-content active-tab">
<div class="card">
<div class="card-header">
<i class="fas fa-unlock-alt"></i>
<h3>فتح القفل باستخدام الصورة وكلمة المرور</h3>
</div>

<div class="form-group">
<label style="color: var(--primary); margin-bottom: 10px; display: block; font-weight: 500;">اختر الصورة:</label>
<div class="image-gallery" id="verifyGallery">
<!-- سيتم إنشاء الصور ديناميكياً -->
</div>
</div>

<div class="form-group">
<label style="color: var(--primary); margin-bottom: 10px; display: block; font-weight: 500;">كلمة المرور:</label>
<input type="password" class="file-input" id="verifyPassword" placeholder="أدخل كلمة المرور" style="font-size: 16px;">
</div>

<button class="btn" onclick="verifyKey()">
<i class="fas fa-check-circle"></i> تحقق من المفتاح
</button>

<div class="result" id="result"></div>
</div>

<div class="instructions">
<h4><i class="fas fa-info-circle"></i> تعليمات هامة</h4>
<ul>
<li>اختر نفس الصورة التي تم تعيينها كمفتاح</li>
<li>أدخل كلمة المرور الصحيحة التي تم تعيينها مع الصورة</li>
<li>تأكد من صحة كلمة المرور والصورة المختارة</li>
<li>إذا لم تنجح، تحقق من الصورة وكلمة المرور مرة أخرى</li>
</ul>
</div>
</div>

<!-- واجهة الإعدادات -->
<div id="settings" class="tab-content">
<!-- رسالة عندما لا يوجد مفتاح -->
<div id="no-key-section" class="no-key-message hidden">
<i class="fas fa-key"></i>
<h3>لا يوجد مفتاح قفل محفوظ</h3>
<p>يرجى فتح القفل أولاً باستخدام مفتاحك الحالي لتعيين مفتاح جديد</p>
</div>

<!-- محتوى الإعدادات عندما يكون المفتاح متاحاً -->
<div id="settings-content" class="hidden">
<div class="card">
<div class="card-header">
<i class="fas fa-key"></i>
<h3>إدارة المفتاح</h3>
</div>

<div class="form-group">
<label style="color: var(--primary); margin-bottom: 10px; display: block; font-weight: 500;">اختر صورة المفتاح:</label>
<div class="image-gallery" id="settingsGallery">
<!-- سيتم إنشاء الصور ديناميكياً -->
</div>
</div>

<div class="form-group">
<label style="color: var(--primary); margin-bottom: 10px; display: block; font-weight: 500;">كلمة المرور الجديدة:</label>
<input type="password" class="file-input" id="setKeyPassword" placeholder="أدخل كلمة مرور قوية" style="font-size: 16px;">
</div>

<button class="btn" onclick="setKey()">
<i class="fas fa-save"></i> تعيين مفتاح جديد
</button>

<div class="action-buttons">
<button class="btn btn-danger" onclick="removeKey()">
<i class="fas fa-trash-alt"></i> إزالة المفتاح
</button>
</div>
</div>

<div class="card">
<div class="card-header">
<i class="fas fa-shield-alt"></i>
<h3>حماية الملفات والتطبيقات</h3>
</div>

<select id="protectedTarget">
<option value="">-- اختر الهدف للحماية --</option>
<option value="images">📸 الصور</option>
<option value="docs">📄 المستندات</option>
<option value="apps">📱 التطبيقات</option>
<option value="custom">🧩 مخصص</option>
</select>

<div class="action-buttons">
<button class="btn btn-success" onclick="protectSelected()">
<i class="fas fa-lock"></i> تطبيق الحماية
</button>
<button class="btn btn-secondary" onclick="clearProtection()">
<i class="fas fa-unlock"></i> إلغاء الحماية
</button>
</div>

<div class="result" id="protectionStatus"></div>
</div>
</div>
</div>

<!-- قسم الإجراءات بعد التحقق -->
<div id="securedActions" class="hidden">
<div class="session-timeout">
<i class="fas fa-clock"></i> الجلسة ستنتهي خلال <span id="sessionTimer">10:00</span>
</div>

<div class="action-buttons">
<button class="btn" onclick="openTab('settings')">
<i class="fas fa-cog"></i> الإعدادات
</button>
<button class="btn btn-secondary" onclick="lockSession()">
<i class="fas fa-lock"></i> قفل الجلسة
</button>
</div>
</div>
</div>

<script>
let selectedVerifyImage = null;
let selectedSettingsImage = null;

// مصفوفة الصور الطبيعية الجميلة
const naturalImages = [
  {
    url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'جبال الثلج'
  },
  {
    url: 'https://images.unsplash.com/photo-1464822759844-d150b9014e9e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'قمم الجبال'
  },
  {
    url: 'https://images.unsplash.com/photo-1519904981063-b0cf448d479e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'جبال الضباب'
  },
  {
    url: 'https://images.unsplash.com/photo-1533310266094-8898a03807dd?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'الوديان الخضراء'
  },
  {
    url: 'https://images.unsplash.com/photo-1540979388789-6cee28a1cdc9?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'جبال الغروب'
  },
  {
    url: 'https://images.unsplash.com/photo-1454391304352-2bf4678b1a7a?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'المرتفعات الصخرية'
  },
  {
    url: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'الغابات المطيرة'
  },
  {
    url: 'https://images.unsplash.com/photo-1440342359743-84fcb8c21f21?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'أشجار الصنوبر'
  },
  {
    url: 'https://images.unsplash.com/photo-1574263867128-dd9a5af88cff?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'ممر الغابة'
  },
  {
    url: 'https://images.unsplash.com/photo-1511593358241-7eea1f3c84e5?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'الغابة الخضراء'
  },
  {
    url: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'الشاطئ الذهبي'
  },
  {
    url: 'https://images.unsplash.com/photo-1439066615861-d1af74d74000?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'أمواج المحيط'
  },
  {
    url: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'البحر الهادئ'
  },
  {
    url: 'https://images.unsplash.com/photo-1476673160081-cf065607f449?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'الجزر الاستوائية'
  },
  {
    url: 'https://images.unsplash.com/photo-1559827260-dc66d52bef19?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'الشعاب المرجانية'
  },
  {
    url: 'https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'أشجار الخريف'
  },
  {
    url: 'https://images.unsplash.com/photo-1516736923451-535b262d6ff9?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'غابة البامبو'
  },
  {
    url: 'https://images.unsplash.com/photo-1544551763-46a013bb70d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'غروب البحر'
  },
  {
    url: 'https://images.unsplash.com/photo-1518837695005-2083093ee35b?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'الجبال البعيدة'
  },
  {
    url: 'https://images.unsplash.com/photo-1506142167881-95188f25d5c4?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&h=300',
    name: 'قمم الألب'
  }
];

// إنشاء الصور في المعرض - معدّل للصور الطبيعية
function createImageGallery(containerId, isSettings = false) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  
  for (let i = 0; i < naturalImages.length; i++) {
    const imageItem = document.createElement('div');
    imageItem.className = 'image-item';
    imageItem.onclick = () => selectImage(i + 1, isSettings);
    
    const img = document.createElement('img');
    img.src = naturalImages[i].url;
    img.alt = naturalImages[i].name;
    img.loading = 'lazy';
    
    const numberDiv = document.createElement('div');
    numberDiv.className = 'image-number';
    numberDiv.textContent = i + 1;
    
    const nameDiv = document.createElement('div');
    nameDiv.className = 'image-name';
    nameDiv.textContent = naturalImages[i].name;
    
    imageItem.appendChild(img);
    imageItem.appendChild(numberDiv);
    imageItem.appendChild(nameDiv);
    imageItem.dataset.imageId = i + 1;
    
    container.appendChild(imageItem);
  }
}

// اختيار صورة
function selectImage(imageId, isSettings = false) {
  const galleryId = isSettings ? 'settingsGallery' : 'verifyGallery';
  const container = document.getElementById(galleryId);
  
  // إزالة التحديد السابق
  container.querySelectorAll('.image-item').forEach(item => {
    item.classList.remove('selected');
  });
  
  // تحديد الصورة الجديدة
  const selectedItem = container.querySelector(`[data-image-id="${imageId}"]`);
  selectedItem.classList.add('selected');
  
  if (isSettings) {
    selectedSettingsImage = imageId;
  } else {
    selectedVerifyImage = imageId;
  }
}

// دالة لحساب بصمة مركبة من الصورة وكلمة المرور
async function calculateCombinedHash(imageId, password) {
  try {
    // إنشاء string مركب من معرف الصورة وكلمة المرور
    const combinedData = `image_${imageId}_password_${password}`;
    const encoder = new TextEncoder();
    const data = encoder.encode(combinedData);
    
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  } catch (error) {
    console.error("Error calculating hash:", error);
    showResult("حدث خطأ أثناء معالجة البيانات", "fail");
    return null;
  }
}

// دالة التحقق من المفتاح
async function verifyKey() {
  if (!selectedVerifyImage) {
    showResult("يرجى اختيار صورة للتحقق منها", "fail");
    return;
  }

  const password = document.getElementById("verifyPassword").value;
  if (!password) {
    showResult("يرجى إدخال كلمة المرور", "fail");
    return;
  }

  const storedHash = localStorage.getItem("keynova_combined_hash");

  if (!storedHash) {
    showResult("لا يوجد مفتاح محفوظ، يرجى تعيين مفتاح أولًا", "warning");
    document.getElementById("settings-content").classList.remove("hidden");
    document.getElementById("no-key-section").classList.add("hidden");
    return;
  }

  showResult("جاري التحقق من المفتاح...", "warning");

  try {
    const currentHash = await calculateCombinedHash(selectedVerifyImage, password);
    if (!currentHash) return;

    if (currentHash === storedHash) {
      showResult("تم التحقق بنجاح! الجلسة مفعلة الآن", "success");
      document.getElementById("securedActions").classList.remove("hidden");
      document.getElementById("settings-content").classList.remove("hidden");
      document.getElementById("no-key-section").classList.add("hidden");
      startSessionTimer();
    } else {
      showResult("الصورة أو كلمة المرور غير صحيحة", "fail");
    }
  } catch (error) {
    console.error("Verification error:", error);
    showResult("حدث خطأ أثناء عملية التحقق", "fail");
  }
}

// دالة تعيين مفتاح جديد
async function setKey() {
  if (!selectedSettingsImage) {
    showResult("يرجى اختيار صورة لتعيينها كمفتاح", "fail");
    return;
  }

  const password = document.getElementById("setKeyPassword").value;
  if (!password) {
    showResult("يرجى إدخال كلمة مرور", "fail");
    return;
  }

  if (password.length < 4) {
    showResult("كلمة المرور يجب أن تكون 4 أحرف على الأقل", "fail");
    return;
  }

  // إنشاء modal تأكيد مخصص
  const confirmChange = await showConfirmDialog("هل أنت متأكد من تغيير المفتاح؟ لن تتمكن من فتح القفل بدون هذه الصورة وكلمة المرور.");
  if (!confirmChange) return;

  try {
    const hash = await calculateCombinedHash(selectedSettingsImage, password);
    if (!hash) return;

    localStorage.setItem("keynova_combined_hash", hash);
    showResult("تم حفظ المفتاح الجديد بنجاح", "success");
    
    // مسح الحقول
    document.getElementById("setKeyPassword").value = '';
    selectedSettingsImage = null;
    document.querySelectorAll('#settingsGallery .image-item').forEach(item => {
      item.classList.remove('selected');
    });
  } catch (error) {
    console.error("Error setting key:", error);
    showResult("حدث خطأ أثناء حفظ المفتاح", "fail");
  }
}

// إزالة المفتاح
async function removeKey() {
  if (!localStorage.getItem("keynova_combined_hash")) {
    showResult("لا يوجد مفتاح محفوظ", "fail");
    return;
  }

  const confirmDelete = await showConfirmDialog("هل أنت متأكد من إزالة المفتاح؟ لن تتمكن من استخدام القفل بعد هذه العملية.");
  if (!confirmDelete) return;

  localStorage.removeItem("keynova_combined_hash");
  localStorage.removeItem("protected_target");
  document.getElementById("securedActions").classList.add("hidden");
  document.getElementById("settings-content").classList.add("hidden");
  document.getElementById("no-key-section").classList.remove("hidden");
  showResult("تمت إزالة المفتاح بنجاح", "success");
}

// دالة إنشاء modal تأكيد مخصص
function showConfirmDialog(message) {
  return new Promise((resolve) => {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    `;
    
    modal.innerHTML = `
      <div style="
        background: var(--dark-light);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        max-width: 400px;
        width: 90%;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
      ">
        <i class="fas fa-question-circle" style="font-size: 48px; color: var(--warning); margin-bottom: 20px;"></i>
        <p style="color: var(--light); margin-bottom: 30px; font-size: 16px; line-height: 1.5;">${message}</p>
        <div style="display: flex; gap: 15px; justify-content: center;">
          <button id="cancelBtn" style="
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
          ">إلغاء</button>
          <button id="confirmBtn" style="
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
          ">تأكيد</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.querySelector('#cancelBtn').onclick = () => {
      document.body.removeChild(modal);
      resolve(false);
    };
    
    modal.querySelector('#confirmBtn').onclick = () => {
      document.body.removeChild(modal);
      resolve(true);
    };
    
    // إغلاق عند النقر خارج المحتوى
    modal.onclick = (e) => {
      if (e.target === modal) {
        document.body.removeChild(modal);
        resolve(false);
      }
    };
  });
}

// حماية الهدف المحدد
function protectSelected() {
  const target = document.getElementById("protectedTarget").value;
  
  if (!target) {
    showResult("يرجى اختيار هدف للحماية", "fail");
    return;
  }

  localStorage.setItem("protected_target", target);
  showResult(`تم تفعيل الحماية على: ${getTargetName(target)}`, "success");
}

// إلغاء الحماية
function clearProtection() {
  if (!localStorage.getItem("protected_target")) {
    showResult("لا توجد حماية مفعلة حالياً", "fail");
    return;
  }

  localStorage.removeItem("protected_target");
  showResult("تم إلغاء الحماية بنجاح", "success");
}

// تبديل التبويبات
function openTab(tabName) {
  // إخفاء جميع التبويبات
  document.querySelectorAll('.tab-content').forEach(tab => {
    tab.classList.remove('active-tab');
  });

  // إظهار التبويب المطلوب
  document.getElementById(tabName).classList.add('active-tab');

  // تحديث أزرار التبويبات
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });

  event.currentTarget.classList.add('active');
}

// عرض النتائج
function showResult(message, type) {
  const resultDiv = document.getElementById("result");
  resultDiv.textContent = message;
  resultDiv.className = "result " + type;
}

// بدء مؤقت الجلسة
function startSessionTimer() {
  let timeLeft = 600; // 10 دقائق بالثواني
  const timerElement = document.getElementById("sessionTimer");

  const timer = setInterval(() => {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;

    timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

    if (timeLeft <= 0) {
      clearInterval(timer);
      lockSession();
    } else {
      timeLeft--;
    }
  }, 1000);
}

// قفل الجلسة
function lockSession() {
  document.getElementById("securedActions").classList.add("hidden");
  document.getElementById("settings-content").classList.add("hidden");
  document.getElementById("no-key-section").classList.remove("hidden");
  showResult("انتهت صلاحية الجلسة، يرجى إعادة التحقق", "warning");
  
  // مسح التحديدات
  selectedVerifyImage = null;
  selectedSettingsImage = null;
  document.getElementById("verifyPassword").value = '';
  document.querySelectorAll('.image-item').forEach(item => {
    item.classList.remove('selected');
  });
}

// الحصول على اسم الهدف
function getTargetName(target) {
  const targets = {
    'images': 'الصور',
    'docs': 'المستندات',
    'apps': 'التطبيقات',
    'custom': 'مخصص'
  };
  return targets[target] || target;
}

// تهيئة الصفحة عند التحميل
window.onload = function() {
  // إنشاء معارض الصور
  createImageGallery('verifyGallery', false);
  createImageGallery('settingsGallery', true);
  
  // تحميل حالة الحماية إن وجدت
  const storedTarget = localStorage.getItem("protected_target");
  if (storedTarget) {
    document.getElementById("protectionStatus").textContent = `الحماية مفعّلة على: ${getTargetName(storedTarget)}`;
    document.getElementById("protectionStatus").className = "result success";
  }

  // التحقق من وجود مفتاح
  const hasKey = localStorage.getItem("keynova_combined_hash") !== null;

  if (hasKey) {
    document.getElementById("settings-content").classList.add("hidden");
    document.getElementById("no-key-section").classList.add("hidden");
  } else {
    document.getElementById("settings-content").classList.remove("hidden");
    document.getElementById("no-key-section").classList.remove("hidden");
  }
};
</script>
</body>
</html>
