<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keynova Lock - Ù‚ÙÙ„ Ø¨ØµØ±ÙŠ Ø¢Ù…Ù†</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #ff8800;
  --primary-dark: #e67600;
  --dark: #121212;
  --dark-light: #1e1e1e;
  --light: #f5f5f5;
  --success: #00c853;
  --danger: #ff4444;
  --warning: #ffbb33;
  --gray: #b9b9b9;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Tajawal', Arial, sans-serif;
  background-color: var(--dark);
  color: var(--light);
  min-height: 100vh;
  padding: 20px;
  direction: rtl;
  text-align: right;
}

.container { max-width: 520px; margin: 0 auto; padding: 20px; }
header { text-align: center; padding: 20px 0 30px; position: relative; }
.logo {
  background: linear-gradient(135deg, #ff8800, #ff5500);
  width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 15px;
  display: flex; align-items: center; justify-content: center;
  box-shadow: 0 5px 15px rgba(255, 136, 0, 0.3);
}
.logo i { font-size: 36px; color: white; }
h1 { color: var(--primary); font-size: 28px; margin-bottom: 5px; }
.subtitle { color: var(--gray); font-size: 14px; font-weight: 400; }

.card {
  background-color: var(--dark-light);
  border-radius: 16px; padding: 20px; margin-bottom: 20px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.05);
}

.card-header { display: flex; align-items: center; margin-bottom: 15px; color: var(--primary); }
.card-header i { font-size: 20px; margin-left: 10px; }
.card-header h3 { font-size: 18px; font-weight: 700; }

.form-group { margin-bottom: 14px; }
.input {
  width: 100%; padding: 14px 44px 14px 14px;
  background-color: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px; color: var(--light); font-size: 16px;
  transition: all 0.3s ease;
}
.input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(255, 136, 0, 0.2); }

.input-wrapper { position: relative; }
.input-wrapper .toggle {
  position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
  background: transparent; border: none; color: var(--gray); cursor: pointer;
  font-size: 16px;
}

.image-gallery {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
  gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px;
  background: rgba(255, 255, 255, 0.03); border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.image-item {
  position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden;
  cursor: pointer; transition: all 0.25s ease; border: 2px solid transparent;
  display: flex; align-items: center; justify-content: center; background: #0f0f0f;
}
.image-item:hover { transform: translateY(-2px); border-color: var(--primary); }
.image-item.selected { border-color: var(--primary); box-shadow: 0 0 10px rgba(255, 136, 0, 0.5); }
.image-item img { width: 100%; height: 100%; object-fit: cover; }
.image-number {
  position: absolute; top: 5px; right: 5px; background: rgba(0, 0, 0, 0.7); color: white;
  border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: bold;
}
.image-badge {
  position: absolute; left: 6px; bottom: 6px; font-size: 11px; color: white;
  background: rgba(0,0,0,.6); padding: 2px 6px; border-radius: 999px;
}

.tile-upload {
  border: 2px dashed rgba(255, 255, 255, 0.2); color: var(--gray);
  display: flex; flex-direction: column; gap: 6px;
}
.tile-upload i { font-size: 24px; color: var(--primary); }
.tile-upload span { font-size: 12px; }

.btn {
  display: block; width: 100%; padding: 14px; background: var(--primary); color: white;
  border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer;
  transition: all 0.3s ease; margin-top: 10px; text-align: center;
}
.btn:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 5px 15px rgba(255, 136, 0, 0.3); }
.btn:active { transform: translateY(0); }
.btn-secondary { background: rgba(255, 255, 255, 0.1); }
.btn-danger { background: var(--danger); }
.btn-success { background: var(--success); }

select {
  width: 100%; padding: 14px; background-color: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px;
  color: var(--light); font-size: 16px; margin-bottom: 12px;
}
select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 2px rgba(255, 136, 0, 0.2); }

.result {
  padding: 12px; border-radius: 10px; margin-top: 10px; text-align: center;
  font-size: 15px; font-weight: 500; display: none;
}
.success { background-color: rgba(0, 200, 83, 0.15); color: #00ff99; display: block; }
.fail { background-color: rgba(255, 68, 68, 0.15); color: #ff6b6b; display: block; }
.warning { background-color: rgba(255, 187, 51, 0.15); color: #ffbb33; display: block; }

.hidden { display: none; }

.action-buttons {
  display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;
}
.action-buttons .btn { margin: 0; }

.session-timeout {
  background: rgba(255, 187, 51, 0.1); border: 1px solid rgba(255, 187, 51, 0.2);
  padding: 10px; border-radius: 10px; text-align: center; margin-top: 10px; font-size: 14px; color: var(--warning);
}

.instructions {
  background: rgba(255, 255, 255, 0.03); border-radius: 10px; padding: 12px; margin-top: 15px; border-right: 3px solid var(--primary);
}
.instructions h4 { color: var(--primary); margin-bottom: 8px; font-size: 16px; }
.instructions li { margin-bottom: 6px; color: var(--gray); font-size: 14px; }

.tabs {
  display: flex; justify-content: space-between; background: rgba(255, 255, 255, 0.05);
  border-radius: 12px; padding: 5px; margin-bottom: 15px;
}
.tab-btn {
  flex: 1; padding: 10px; text-align: center; background: transparent; color: var(--gray);
  border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;
}
.tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(255, 136, 0, 0.3); }
.tab-content { display: none; }
.tab-content.active-tab { display: block; }

.small {
  font-size: 12px; color: var(--gray);
}
.row { display: flex; gap: 8px; align-items: center; }
.row .input { flex: 1; }
.icon-btn {
  background: rgba(255,255,255,0.08); color: var(--light); border: 1px solid rgba(255,255,255,0.12);
  padding: 8px 10px; border-radius: 8px; cursor: pointer; transition: .2s;
}
.icon-btn:hover { background: rgba(255,255,255,0.16); }

.user-image-actions {
  position: absolute; top: 6px; left: 6px; display: flex; gap: 6px; z-index: 2;
}
.user-image-actions button {
  background: rgba(0,0,0,.55); color: #fff; border: 0; padding: 4px 6px; font-size: 11px;
  border-radius: 6px; cursor: pointer;
}

@media (max-width: 480px) {
  .container { padding: 10px; }
  .card { padding: 16px; }
  .action-buttons { grid-template-columns: 1fr; }
  h1 { font-size: 24px; }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo"><i class="fas fa-lock"></i></div>
    <h1>Keynova Lock</h1>
    <p class="subtitle">Ù‚ÙÙ„ Ø¨ØµØ±ÙŠ Ø¢Ù…Ù† Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ± ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
    <p class="subtitle">Ù…Ø·ÙˆØ± Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…: Ø±Ø£ÙØª Ø¹Ù…Ø±</p>
  </header>

  <div class="tabs">
    <button id="tab-verify" class="tab-btn active" data-tab="verify">ÙØªØ­ Ø§Ù„Ù‚ÙÙ„</button>
    <button id="tab-settings" class="tab-btn" data-tab="settings">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </div>

  <!-- ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ -->
  <div id="verify" class="tab-content active-tab">
    <div class="card">
      <div class="card-header">
        <i class="fas fa-unlock-alt"></i><h3>Ø§ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© + ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
      </div>

      <div class="form-group">
        <label style="color: var(--primary); margin-bottom: 8px; display: block; font-weight: 600;">Ø§Ø®ØªØ± Ø§Ù„ØµÙˆØ±Ø©:</label>
        <div class="image-gallery" id="verifyGallery"></div>
        <div class="small">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¯ÙŠÙˆ ÙˆØ³ÙŠØªÙ… Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ù…ØµØºÙ‘Ø±Ø© Ù…Ø­Ù„ÙŠØ§Ù‹.</div>
      </div>

      <div class="form-group">
        <label style="color: var(--primary); margin-bottom: 8px; display: block; font-weight: 600;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
        <div class="input-wrapper">
          <input type="password" class="input" id="verifyPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
          <button class="toggle" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡" data-toggle="#verifyPassword"><i class="far fa-eye"></i></button>
        </div>
        <div class="small" id="attemptInfo"></div>
      </div>

      <button class="btn" id="btnVerify"><i class="fas fa-check-circle"></i> ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­</button>
      <div class="result" id="result"></div>
    </div>

    <div class="instructions">
      <h4><i class="fas fa-info-circle"></i> ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù‡Ø§Ù…Ø©</h4>
      <ul>
        <li>Ø§Ø®ØªØ± Ù†ÙØ³ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªÙ… ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙƒÙ…ÙØªØ§Ø­ (Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ù…Ø¬ Ø£Ùˆ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¯ÙŠÙˆ).</li>
        <li>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„ØµØ­ÙŠØ­Ø© Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨ØªÙ„Ùƒ Ø§Ù„ØµÙˆØ±Ø©.</li>
        <li>Ø³ÙŠØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ù…Ø¯Ø© Ù‚ØµÙŠØ±Ø© Ø¨Ø¹Ø¯ Ø¹Ø¯Ø© Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø®Ø§Ø·Ø¦Ø©.</li>
      </ul>
    </div>
  </div>

  <!-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div id="settings" class="tab-content">
    <div id="no-key-section" class="card">
      <div class="card-header">
        <i class="fas fa-key"></i><h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ù…ÙÙØ¹Ù‘Ù„</h3>
      </div>
      <p class="small">Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯ Ø£Ø¯Ù†Ø§Ù‡. Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹ÙŠÙŠÙ†ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡ Ù„ÙØªØ­ Ø§Ù„Ù‚ÙÙ„.</p>
    </div>

    <div id="settings-content" class="card">
      <div class="card-header">
        <i class="fas fa-key"></i><h3>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙØªØ§Ø­</h3>
      </div>

      <div class="form-group">
        <label style="color: var(--primary); margin-bottom: 8px; display: block; font-weight: 600;">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ù…ÙØªØ§Ø­:</label>
        <div class="image-gallery" id="settingsGallery"></div>
      </div>

      <div class="form-group">
        <label style="color: var(--primary); margin-bottom: 8px; display: block; font-weight: 600;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label>
        <div class="input-wrapper">
          <input type="password" class="input" id="setKeyPassword" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©">
          <button class="toggle" aria-label="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡" data-toggle="#setKeyPassword"><i class="far fa-eye"></i></button>
        </div>
        <div class="small" id="pwStrength"></div>
      </div>

      <button class="btn" id="btnSetKey"><i class="fas fa-save"></i> ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯</button>

      <div class="action-buttons">
        <button class="btn btn-danger" id="btnRemoveKey"><i class="fas fa-trash-alt"></i> Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­</button>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <i class="fas fa-shield-alt"></i><h3>Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</h3>
      </div>

      <select id="protectedTarget">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ù Ù„Ù„Ø­Ù…Ø§ÙŠØ© --</option>
        <option value="images">ğŸ“¸ Ø§Ù„ØµÙˆØ±</option>
        <option value="docs">ğŸ“„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª</option>
        <option value="apps">ğŸ“± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª</option>
        <option value="custom">ğŸ§© Ù…Ø®ØµØµ</option>
      </select>

      <div class="action-buttons">
        <button class="btn btn-success" id="btnProtect"><i class="fas fa-lock"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù…Ø§ÙŠØ©</button>
        <button class="btn btn-secondary" id="btnUnprotect"><i class="fas fa-unlock"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ù…Ø§ÙŠØ©</button>
      </div>

      <div class="result" id="protectionStatus"></div>
    </div>
  </div>

  <!-- Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ -->
  <div id="securedActions" class="hidden">
    <div class="session-timeout">
      <i class="fas fa-clock"></i> Ø§Ù„Ø¬Ù„Ø³Ø© Ø³ØªÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„ <span id="sessionTimer">10:00</span>
    </div>
    <div class="action-buttons">
      <button class="btn" data-tab-jump="settings"><i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <button class="btn btn-secondary" id="btnLock"><i class="fas fa-lock"></i> Ù‚ÙÙ„ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
    </div>
  </div>
</div>

<!-- Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø®ÙÙŠØ© (Ø§Ù„ØªØ­Ù‚Ù‚/Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª) -->
<input type="file" accept="image/*" capture="environment" id="fileVerify" class="hidden">
<input type="file" accept="image/*" capture="environment" id="fileSettings" class="hidden">

<script>
/* ======= Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ======= */
const LS_KEYS = {
  COMBINED_HASH: 'keynova_combined_hash',
  USER_IMAGES: 'keynova_user_images',
  PROTECTED_TARGET: 'protected_target',
  LOCKOUT_UNTIL: 'keynova_lockout_until',
  ATTEMPTS: 'keynova_attempts',
  KEY_META: 'keynova_key_meta'
};

const state = {
  selectedVerify: null,   // {type:'builtin'|'user', id, hash}
  selectedSettings: null, // {type:'builtin'|'user', id, hash}
  userImages: []          // [{id, name, dataUrl, hash}]
};

let sessionTimerHandle = null;

/* ======= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ======= */
function toUint8ArrayFromDataURL(dataUrl) {
  const [meta, b64] = dataUrl.split(',');
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return bytes;
}

async function sha256Hex(bytes) {
  const buf = await crypto.subtle.digest('SHA-256', bytes);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function hashDataURL(dataUrl) {
  return sha256Hex(toUint8ArrayFromDataURL(dataUrl));
}

async function combinedHash(imageHash, password) {
  const enc = new TextEncoder().encode(`${imageHash}:${password}`);
  return sha256Hex(enc);
}

function showResult(message, type = 'success') {
  const el = document.getElementById('result');
  el.textContent = message;
  el.className = 'result ' + type;
}

function showStatus(id, message, type = 'success') {
  const el = document.getElementById(id);
  el.textContent = message;
  el.className = 'result ' + type;
}

function isLockedOut() {
  const until = parseInt(localStorage.getItem(LS_KEYS.LOCKOUT_UNTIL) || '0', 10);
  const now = Date.now();
  return now < until ? until - now : 0;
}

function setLockout(ms) {
  localStorage.setItem(LS_KEYS.LOCKOUT_UNTIL, (Date.now() + ms).toString());
}

function getAttempts() {
  return parseInt(localStorage.getItem(LS_KEYS.ATTEMPTS) || '0', 10);
}
function setAttempts(n) {
  localStorage.setItem(LS_KEYS.ATTEMPTS, String(n));
  const info = document.getElementById('attemptInfo');
  const left = Math.max(0, 5 - n);
  info.textContent = left > 0 ? `Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ${left} Ù…Ù† 5` : 'ØªÙ… Ø¨Ù„ÙˆØº Ø§Ù„Ø­Ø¯. Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.';
}

function assessPassword(pw) {
  let score = 0;
  if (pw.length >= 8) score++;
  if (/[A-Z]/.test(pw)) score++;
  if (/[a-z]/.test(pw)) score++;
  if (/\d/.test(pw)) score++;
  if (/[^A-Za-z0-9]/.test(pw)) score++;
  return score; // 0..5
}

function fmtTime(ms) {
  const total = Math.ceil(ms / 1000);
  const m = Math.floor(total / 60);
  const s = total % 60;
  return `${m}:${s < 10 ? '0' : ''}${s}`;
}

/* ======= Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ù…Ø¬ (ØµÙˆØ± Ù…ÙˆÙ„Ù‘Ø¯Ø©) ======= */
function generateBuiltinDataURL(i) {
  const canvas = document.createElement('canvas');
  canvas.width = 128; canvas.height = 128;
  const ctx = canvas.getContext('2d');

  const g = ctx.createLinearGradient(0, 0, 128, 128);
  const hue1 = (i * 17) % 360;
  const hue2 = (hue1 + 60) % 360;
  g.addColorStop(0, `hsl(${hue1}, 70%, 60%)`);
  g.addColorStop(1, `hsl(${hue2}, 70%, 40%)`);
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, 128, 128);

  ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
  ctx.fillRect(10 + (i % 3) * 20, 10 + (i % 4) * 15, 30, 30);
  ctx.fillRect(50 + (i % 2) * 25, 50 + (i % 3) * 20, 25, 25);

  return canvas.toDataURL('image/png');
}

/* ======= Ø¥Ø¯Ø§Ø±Ø© ØµÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ======= */
function loadUserImages() {
  try {
    state.userImages = JSON.parse(localStorage.getItem(LS_KEYS.USER_IMAGES) || '[]');
  } catch { state.userImages = []; }
}
function saveUserImages() {
  localStorage.setItem(LS_KEYS.USER_IMAGES, JSON.stringify(state.userImages));
}

async function addUserImageFromFile(file, galleryId) {
  if (!file || !file.type.startsWith('image/')) return;
  const dataUrl = await readAndResize(file, 192);
  const hash = await hashDataURL(dataUrl);
  const id = 'u-' + Date.now() + '-' + Math.random().toString(36).slice(2, 8);
  const name = file.name || 'ØµÙˆØ±Ø©';
  state.userImages.unshift({ id, name, dataUrl, hash });
  saveUserImages();
  createImageGallery(galleryId, galleryId === 'settingsGallery');
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶Ø§ÙØ© Ù…Ø¨Ø§Ø´Ø±Ø©
  selectImage({ type: 'user', id, hash }, galleryId === 'settingsGallery');
}

function removeUserImage(id) {
  const idx = state.userImages.findIndex(x => x.id === id);
  if (idx >= 0) {
    state.userImages.splice(idx, 1);
    saveUserImages();
    createImageGallery('verifyGallery', false);
    createImageGallery('settingsGallery', true);
  }
}

function renameUserImage(id, newName) {
  const img = state.userImages.find(x => x.id === id);
  if (img) {
    img.name = newName || img.name;
    saveUserImages();
    createImageGallery('verifyGallery', false);
    createImageGallery('settingsGallery', true);
  }
}

function readFileAsDataURL(file) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

async function readAndResize(file, maxSize) {
  const srcUrl = await readFileAsDataURL(file);
  const img = new Image();
  img.src = srcUrl;
  await img.decode();
  const scale = Math.min(maxSize / img.width, maxSize / img.height, 1);
  const w = Math.max(1, Math.round(img.width * scale));
  const h = Math.max(1, Math.round(img.height * scale));
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(img, 0, 0, w, h);
  // JPEG Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…
  return canvas.toDataURL('image/jpeg', 0.8);
}

/* ======= Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ø±Ø¶ ======= */
async function createImageGallery(containerId, isSettings = false) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  const addTile = document.createElement('div');
  addTile.className = 'image-item tile-upload';
  addTile.innerHTML = '<i class="fas fa-plus"></i><span>Ø¥Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¯ÙŠÙˆ</span>';
  addTile.onclick = () => document.getElementById(isSettings ? 'fileSettings' : 'fileVerify').click();
  container.appendChild(addTile);

  // ØµÙˆØ± Ù…Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  state.userImages.forEach(img => {
    const item = document.createElement('div');
    item.className = 'image-item';
    item.dataset.type = 'user';
    item.dataset.id = img.id;
    item.dataset.hash = img.hash;
    item.title = img.name;

    const image = document.createElement('img');
    image.src = img.dataUrl;
    image.alt = img.name;

    const badge = document.createElement('div');
    badge.className = 'image-badge';
    badge.textContent = 'Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¯ÙŠÙˆ';

    // Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© (Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©/Ø­Ø°Ù)
    const actions = document.createElement('div');
    actions.className = 'user-image-actions';
    const btnRename = document.createElement('button');
    btnRename.innerHTML = '<i class="fas fa-pen"></i>';
    btnRename.title = 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©';
    btnRename.onclick = (e) => {
      e.stopPropagation();
      const newName = prompt('Ø§Ø³Ù… Ø§Ù„ØµÙˆØ±Ø©:', img.name);
      if (newName !== null) renameUserImage(img.id, newName.trim());
    };
    const btnDelete = document.createElement('button');
    btnDelete.innerHTML = '<i class="fas fa-trash"></i>';
    btnDelete.title = 'Ø­Ø°Ù';
    btnDelete.onclick = (e) => {
      e.stopPropagation();
      if (confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ')) removeUserImage(img.id);
    };
    actions.append(btnRename, btnDelete);

    item.append(image, badge, actions);
    item.onclick = () => {
      selectImage({ type: 'user', id: img.id, hash: img.hash }, isSettings);
    };
    container.appendChild(item);
  });

  // Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¯Ù…Ø¬
  for (let i = 1; i <= 20; i++) {
    const item = document.createElement('div');
    item.className = 'image-item';
    item.dataset.type = 'builtin';
    item.dataset.id = String(i);

    const dataUrl = generateBuiltinDataURL(i);
    const hash = await hashDataURL(dataUrl);
    item.dataset.hash = hash;

    const image = document.createElement('img');
    image.src = dataUrl; image.alt = `ØµÙˆØ±Ø© ${i}`;
    const numberDiv = document.createElement('div');
    numberDiv.className = 'image-number'; numberDiv.textContent = i;

    const badge = document.createElement('div');
    badge.className = 'image-badge'; badge.textContent = 'Ù…Ø¯Ù…Ø¬';

    item.append(image, numberDiv, badge);
    item.onclick = () => {
      selectImage({ type: 'builtin', id: i, hash }, isSettings);
    };
    container.appendChild(item);
  }
}

function selectImage(sel, isSettings) {
  const galleryId = isSettings ? 'settingsGallery' : 'verifyGallery';
  const container = document.getElementById(galleryId);
  container.querySelectorAll('.image-item').forEach(el => el.classList.remove('selected'));

  // Ø§Ø¬Ø¹Ù„ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…Ù…ÙŠØ²Ø§Ù‹ (Ø¹Ø¯Ø§ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©)
  const query = `.image-item[data-id="${sel.id}"][data-type="${sel.type}"]`;
  const selectedEl = container.querySelector(query);
  if (selectedEl) selectedEl.classList.add('selected');

  if (isSettings) state.selectedSettings = sel;
  else state.selectedVerify = sel;
}

/* ======= ØªØ¨ÙˆÙŠØ¨Ø§Øª ======= */
function openTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active-tab'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  const content = document.getElementById(tabName);
  content.classList.add('active-tab');
  const tabBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
  if (tabBtn) tabBtn.classList.add('active');
}

/* ======= Ø§Ù„ØªØ­Ù‚Ù‚/Ø§Ù„ØªØ¹ÙŠÙŠÙ†/Ø§Ù„Ø¬Ù„Ø³Ø© ======= */
async function verifyKey() {
  const lockMsLeft = isLockedOut();
  if (lockMsLeft > 0) {
    showResult(`Ù…Ø­Ø¸ÙˆØ± Ù…Ø¤Ù‚ØªØ§Ù‹. Ø§Ù†ØªØ¸Ø± ${fmtTime(lockMsLeft)} Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.`, 'warning');
    return;
  }

  if (!state.selectedVerify) {
    showResult('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù†Ù‡Ø§', 'fail'); return;
  }
  const password = document.getElementById('verifyPassword').value;
  if (!password) {
    showResult('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'fail'); return;
  }

  const storedHash = localStorage.getItem(LS_KEYS.COMBINED_HASH);
  if (!storedHash) {
    showResult('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ù…Ø­ÙÙˆØ¸ØŒ Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'warning');
    openTab('settings');
    return;
  }

  showResult('Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...', 'warning');
  const currentHash = await combinedHash(state.selectedVerify.hash, password);
  if (currentHash === storedHash) {
    showResult('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! Ø§Ù„Ø¬Ù„Ø³Ø© Ù…ÙØ¹Ù„Ø© Ø§Ù„Ø¢Ù†', 'success');
    document.getElementById('securedActions').classList.remove('hidden');
    document.getElementById('settings-content').classList.remove('hidden');
    document.getElementById('no-key-section').classList.add('hidden');
    setAttempts(0); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·
    startSessionTimer();
  } else {
    const n = getAttempts() + 1;
    setAttempts(n);
    if (n >= 5) {
      setLockout(30_000); // 30 Ø«Ø§Ù†ÙŠØ© Ø­Ø¸Ø±
      showResult('Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ù…ØªÙƒØ±Ø±Ø©. ØªÙ… Ø§Ù„Ø­Ø¸Ø± Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù…Ø¯Ø© 30 Ø«Ø§Ù†ÙŠØ©.', 'fail');
    } else {
      showResult('Ø§Ù„ØµÙˆØ±Ø© Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'fail');
    }
  }
}

async function setKey() {
  if (!state.selectedSettings) {
    showResult('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ù„ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ ÙƒÙ…ÙØªØ§Ø­', 'fail'); return;
  }
  const pw = document.getElementById('setKeyPassword').value;
  if (!pw) { showResult('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±', 'fail'); return; }
  if (pw.length < 6) { showResult('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'fail'); return; }

  const ok = await confirmDialog('ØªØ£ÙƒÙŠØ¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙØªØ§Ø­ØŸ Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¯ÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø©.');
  if (!ok) return;

  const hash = await combinedHash(state.selectedSettings.hash, pw);
  localStorage.setItem(LS_KEYS.COMBINED_HASH, hash);
  localStorage.setItem(LS_KEYS.KEY_META, JSON.stringify({
    type: state.selectedSettings.type, id: state.selectedSettings.id, imageHash: state.selectedSettings.hash
  }));
  showResult('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');

  // ØªÙ†Ø¸ÙŠÙ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙÙ‚Ø·
  document.getElementById('setKeyPassword').value = '';
  document.getElementById('pwStrength').textContent = '';
}

function removeKey() {
  if (!localStorage.getItem(LS_KEYS.COMBINED_HASH)) {
    showResult('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Ù…Ø­ÙÙˆØ¸', 'fail'); return;
  }
  confirmDialog('Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­ØŸ Ù„Ù† ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù‚ÙÙ„ Ø¨Ø¹Ø¯ Ø°Ù„Ùƒ Ø­ØªÙ‰ ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯.')
    .then(ok => {
      if (!ok) return;
      localStorage.removeItem(LS_KEYS.COMBINED_HASH);
      localStorage.removeItem(LS_KEYS.KEY_META);
      localStorage.removeItem(LS_KEYS.PROTECTED_TARGET);
      document.getElementById('securedActions').classList.add('hidden');
      document.getElementById('settings-content').classList.remove('hidden'); // Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯
      document.getElementById('no-key-section').classList.remove('hidden');
      showResult('ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­ Ø¨Ù†Ø¬Ø§Ø­', 'success');
      showStatus('protectionStatus', '', 'success');
    });
}

function startSessionTimer() {
  clearInterval(sessionTimerHandle);
  let timeLeft = 600; // 10 Ø¯Ù‚Ø§Ø¦Ù‚
  const timerElement = document.getElementById('sessionTimer');
  sessionTimerHandle = setInterval(() => {
    const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
    timerElement.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
    if (timeLeft-- <= 0) {
      clearInterval(sessionTimerHandle);
      lockSession();
    }
  }, 1000);
}

function lockSession() {
  clearInterval(sessionTimerHandle);
  document.getElementById('securedActions').classList.add('hidden');
  showResult('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù‚Ù‚', 'warning');
  // ØªÙ†Ø¸ÙŠÙ Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„ØµÙˆØ±)
  state.selectedVerify = null;
  state.selectedSettings = null;
  document.getElementById('verifyPassword').value = '';
  document.querySelectorAll('.image-item').forEach(item => item.classList.remove('selected'));
}

/* ======= Ø­ÙˆØ§Ø± ØªØ£ÙƒÙŠØ¯ Ø¨Ø³ÙŠØ· ======= */
function confirmDialog(message) {
  return new Promise(resolve => {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: flex; align-items: center; justify-content: center; z-index: 9999;
    `;
    modal.innerHTML = `
      <div style="background: var(--dark-light); padding: 22px; border-radius: 14px; width: min(420px, 92vw);
        border: 1px solid rgba(255,255,255,.1); text-align: center;">
        <i class="fas fa-question-circle" style="font-size: 44px; color: var(--warning);"></i>
        <p style="margin: 16px 0 22px; line-height: 1.6;">${message}</p>
        <div style="display:flex; gap:10px; justify-content:center;">
          <button id="cCancel" class="icon-btn">Ø¥Ù„ØºØ§Ø¡</button>
          <button id="cOk" class="btn" style="margin:0; padding:10px 18px;">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      </div>
    `;
    modal.addEventListener('click', (e) => { if (e.target === modal) { document.body.removeChild(modal); resolve(false); }});
    modal.querySelector('#cCancel').onclick = () => { document.body.removeChild(modal); resolve(false); };
    modal.querySelector('#cOk').onclick = () => { document.body.removeChild(modal); resolve(true); };
    document.body.appendChild(modal);
  });
}

/* ======= Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø£Ù‡Ø¯Ø§Ù (ØªØ¬Ø±ÙŠØ¨ÙŠØ©) ======= */
function protectSelected() {
  const target = document.getElementById('protectedTarget').value;
  if (!target) { showResult('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¯Ù Ù„Ù„Ø­Ù…Ø§ÙŠØ©', 'fail'); return; }
  localStorage.setItem(LS_KEYS.PROTECTED_TARGET, target);
  showStatus('protectionStatus', `ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¹Ù„Ù‰: ${getTargetName(target)}`, 'success');
}
function clearProtection() {
  if (!localStorage.getItem(LS_KEYS.PROTECTED_TARGET)) {
    showStatus('protectionStatus', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹', 'fail'); return;
  }
  localStorage.removeItem(LS_KEYS.PROTECTED_TARGET);
  showStatus('protectionStatus', 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
}
function getTargetName(target) {
  const m = { images: 'Ø§Ù„ØµÙˆØ±', docs: 'Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª', apps: 'Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª', custom: 'Ù…Ø®ØµØµ' };
  return m[target] || target;
}

/* ======= ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ======= */
function wireEvents() {
  // ØªØ¨ÙˆÙŠØ¨Ø§Øª
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => openTab(btn.dataset.tab));
  });
  document.querySelectorAll('[data-tab-jump]').forEach(btn => {
    btn.addEventListener('click', () => openTab(btn.getAttribute('data-tab-jump')));
  });

  // Ø£Ø²Ø±Ø§Ø± Ø±Ø¦ÙŠØ³ÙŠØ©
  document.getElementById('btnVerify').onclick = verifyKey;
  document.getElementById('btnSetKey').onclick = setKey;
  document.getElementById('btnRemoveKey').onclick = removeKey;
  document.getElementById('btnLock').onclick = lockSession;

  // Ø­Ù…Ø§ÙŠØ©
  document.getElementById('btnProtect').onclick = protectSelected;
  document.getElementById('btnUnprotect').onclick = clearProtection;

  // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù„Ù (Ø§Ù„ØªØ­Ù‚Ù‚/Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
  document.getElementById('fileVerify').addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (file) await addUserImageFromFile(file, 'verifyGallery');
    e.target.value = ''; // Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù Ù„Ø§Ø­Ù‚Ø§Ù‹
  });
  document.getElementById('fileSettings').addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (file) await addUserImageFromFile(file, 'settingsGallery');
    e.target.value = '';
  });

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±
  document.querySelectorAll('.toggle').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = document.querySelector(btn.getAttribute('data-toggle'));
      if (!input) return;
      input.type = input.type === 'password' ? 'text' : 'password';
      btn.innerHTML = input.type === 'password' ? '<i class="far fa-eye"></i>' : '<i class="far fa-eye-slash"></i>';
    });
  });

  // Ù‚ÙˆØ© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
  document.getElementById('setKeyPassword').addEventListener('input', (e) => {
    const score = assessPassword(e.target.value);
    const tips = ['Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ø§Ù‹', 'Ø¶Ø¹ÙŠÙØ©', 'Ù…ØªÙˆØ³Ø·Ø©', 'Ø¬ÙŠØ¯Ø©', 'Ù‚ÙˆÙŠØ©', 'Ù‚ÙˆÙŠØ© Ø¬Ø¯Ø§Ù‹'];
    const colors = ['#ff6b6b', '#ff9e6b', '#ffbb33', '#ffd166', '#9cff6b', '#00ff99'];
    const el = document.getElementById('pwStrength');
    el.textContent = e.target.value ? `Ù‚ÙˆØ© Ø§Ù„ÙƒÙ„Ù…Ø©: ${tips[score]}` : '';
    el.style.color = colors[score];
  });
}

/* ======= Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ======= */
async function init() {
  loadUserImages();
  await createImageGallery('verifyGallery', false);
  await createImageGallery('settingsGallery', true);

  // Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
  const storedTarget = localStorage.getItem(LS_KEYS.PROTECTED_TARGET);
  if (storedTarget) showStatus('protectionStatus', `Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù‘Ù„Ø© Ø¹Ù„Ù‰: ${getTargetName(storedTarget)}`, 'success');

  // Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙØªØ§Ø­
  const hasKey = !!localStorage.getItem(LS_KEYS.COMBINED_HASH);
  document.getElementById('settings-content').classList.remove('hidden'); // Ù†ÙØ¸Ù‡Ø±Ù‡Ø§ Ù„ØªØ¹ÙŠÙŠÙ† Ù…ÙØªØ§Ø­
  if (!hasKey) {
    document.getElementById('no-key-section').classList.remove('hidden');
  } else {
    document.getElementById('no-key-section').classList.add('hidden');
  }

  // Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª/Ø§Ù„Ø­Ø¸Ø±
  setAttempts(getAttempts());
}

window.addEventListener('load', () => {
  wireEvents();
  init();
});
</script>
</body>
</html>
